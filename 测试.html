<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ—¥è¯­è´ªåƒè›‡Â·æ— é™è¿›åŒ–</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka+One&family=Noto+Sans+JP:wght@400;700&display=swap');

        :root {
            --primary: #FF4081;
            --secondary: #00E5FF;
            --bg-color: #f0f4f8;
            --panel-bg: rgba(255, 255, 255, 0.9);
            --text-color: #333;
            --font-main: 'Fredoka One', 'Noto Sans JP', sans-serif;
        }

        /* ================= ğŸ¨ é£æ ¼å®šä¹‰ ================= */
        /* 1. é©¬å¡é¾™ (é»˜è®¤) */
        body[data-theme="macaron"] { --bg-color: #FFF0F5; --primary: #FF80AB; --secondary: #80D8FF; --text-color: #880E4F; }
        /* 2. èµ›åšæœ‹å…‹ */
        body[data-theme="cyber"] { --bg-color: #050510; --primary: #00FF00; --secondary: #FF00FF; --panel-bg: rgba(0,0,0,0.8); --text-color: #00FF00; }
        /* 3. è«å…°è¿ª */
        body[data-theme="morandi"] { --bg-color: #D7D2CC; --primary: #8F9E9D; --secondary: #BCAAA4; --text-color: #4E4E4E; }
        /* 4. æš—é»‘éœ“è™¹ */
        body[data-theme="dark"] { --bg-color: #121212; --primary: #FF3D00; --secondary: #FFEA00; --panel-bg: rgba(30,30,30,0.95); --text-color: #FFF; }

        * { box-sizing: border-box; touch-action: none; user-select: none; -webkit-tap-highlight-color: transparent; }
        
        body {
            margin: 0; padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: var(--font-main);
            height: 100vh; overflow: hidden;
            display: flex; flex-direction: column;
            transition: background 0.5s;
        }

        /* åŠ¨æ€èƒŒæ™¯ç½‘æ ¼ */
        #bgCanvas { position: absolute; top:0; left:0; width:100%; height:100%; z-index: -1; opacity: 0.3; }

        /* HUD */
        .hud {
            position: absolute; top: 0; left: 0; width: 100%;
            padding: 15px 20px;
            display: flex; justify-content: space-between; align-items: flex-start;
            z-index: 20; pointer-events: none; /* è®©ç‚¹å‡»ç©¿é€ */
        }
        .hud-left, .hud-right { display: flex; flex-direction: column; gap: 10px; pointer-events: auto; }
        
        .pill {
            background: var(--panel-bg); backdrop-filter: blur(5px);
            padding: 8px 16px; border-radius: 30px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            font-size: 16px; font-weight: bold; display: flex; align-items: center; gap: 8px;
            border: 2px solid rgba(255,255,255,0.5);
        }
        .bar-container {
            width: 150px; height: 12px; background: rgba(0,0,0,0.1);
            border-radius: 6px; overflow: hidden; margin-top: 5px; border: 1px solid rgba(255,255,255,0.5);
        }
        .fever-bar {
            height: 100%; width: 0%; background: linear-gradient(90deg, #FFC107, #FF5722);
            transition: width 0.3s;
        }
        
        /* æ¸¸æˆç”»å¸ƒ */
        .game-container {
            flex: 1; position: relative; width: 100%; height: 100%;
            display: flex; justify-content: center; align-items: center;
        }
        canvas#gameCanvas { z-index: 1; }

        /* æ‘‡æ† */
        .controls {
            position: absolute; bottom: 30px; left: 30px; right: 30px;
            display: flex; justify-content: space-between; align-items: flex-end;
            z-index: 30; pointer-events: none;
        }
        .joystick-zone {
            width: 120px; height: 120px; background: rgba(255,255,255,0.15);
            border: 2px solid rgba(255,255,255,0.4); border-radius: 50%;
            position: relative; pointer-events: auto; backdrop-filter: blur(2px);
        }
        .stick {
            width: 50px; height: 50px; background: var(--primary);
            border-radius: 50%; position: absolute; top: 35px; left: 35px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3); border: 2px solid white;
        }
        .action-btn {
            width: 80px; height: 80px; background: white;
            border-radius: 50%; border: 4px solid var(--primary);
            display: flex; justify-content: center; align-items: center;
            font-size: 28px; color: var(--primary);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2); pointer-events: auto;
            transition: 0.1s; cursor: pointer;
        }
        .action-btn:active { transform: scale(0.9); background: var(--primary); color: white; }

        /* å…¨å± UI (èœå•/å•†åº—) */
        .screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.95); z-index: 100;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: 0.3s; backdrop-filter: blur(10px);
        }
        .hidden { opacity: 0; pointer-events: none; }
        
        h1 { font-size: 32px; margin-bottom: 10px; color: var(--primary); text-shadow: 2px 2px 0px var(--secondary); }
        
        .btn-main {
            background: linear-gradient(45deg, var(--primary), var(--secondary));
            color: white; border: none; padding: 15px 40px;
            border-radius: 50px; font-size: 20px; font-weight: bold;
            margin: 10px; cursor: pointer; box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            transition: transform 0.2s; width: 80%; max-width: 300px;
        }
        .btn-main:active { transform: scale(0.95); }
        .btn-sub { background: #eee; color: #555; font-size: 16px; padding: 10px 30px; }

        /* å•†åº—ç½‘æ ¼ */
        .shop-grid {
            display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;
            max-height: 50vh; overflow-y: auto; padding: 10px; width: 90%; max-width: 400px;
        }
        .skin-card {
            background: white; border-radius: 15px; padding: 15px;
            display: flex; flex-direction: column; align-items: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); border: 2px solid transparent;
            cursor: pointer; position: relative;
        }
        .skin-card.active { border-color: var(--primary); background: #fff0f5; }
        .skin-card.locked { opacity: 0.7; filter: grayscale(0.8); }
        .skin-preview { width: 40px; height: 40px; border-radius: 50%; margin-bottom: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .price-tag { font-size: 12px; background: #FFC107; color: #333; padding: 2px 8px; border-radius: 10px; margin-top: 5px; }

        /* ç‹‚çƒ­æ¨¡å¼ç‰¹æ•ˆ */
        .fever-overlay {
            position: absolute; top:0; left:0; width:100%; height:100%;
            background: radial-gradient(circle, transparent 50%, rgba(255,0,0,0.2) 100%);
            z-index: 10; pointer-events: none; opacity: 0; transition: 0.3s;
            mix-blend-mode: overlay;
        }
        .fever-active .fever-overlay { opacity: 1; animation: pulse 0.5s infinite; }

        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }

        .toast {
            position: absolute; top: 30%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.8); color: white; padding: 10px 20px; border-radius: 20px;
            font-size: 18px; opacity: 0; transition: 0.3s; pointer-events: none; z-index: 50;
        }
        .toast.show { opacity: 1; top: 25%; }

    </style>
</head>
<body data-theme="macaron">

    <!-- èƒŒæ™¯ç”»å¸ƒ -->
    <canvas id="bgCanvas"></canvas>
    <div class="fever-overlay"></div>

    <!-- HUD -->
    <div class="hud" id="hud" style="display:none;">
        <div class="hud-left">
            <div class="pill">ğŸ† <span id="scoreVal">0</span></div>
            <div class="pill">ğŸ’° <span id="coinVal">0</span></div>
            <div class="bar-container">
                <div class="fever-bar" id="feverBar"></div>
            </div>
            <div style="font-size:10px; color:var(--text-color); font-weight:bold;">FEVER</div>
        </div>
        <div class="hud-right">
            <div class="pill" style="color:var(--primary); font-size:18px;">ğŸ¯ <span id="targetVal">?</span></div>
            <div class="pill" onclick="pauseGame()" style="cursor:pointer;">â¸</div>
        </div>
    </div>

    <!-- æ¸¸æˆåŒº -->
    <div class="game-container">
        <canvas id="gameCanvas"></canvas>
    </div>
    <div class="toast" id="toast">Combo x2!</div>

    <!-- æ§åˆ¶åŒº -->
    <div class="controls" id="controls" style="display:none;">
        <div class="joystick-zone" id="joystick">
            <div class="stick" id="stick"></div>
        </div>
        <div class="action-btn" id="boostBtn">âš¡ï¸</div>
    </div>

    <!-- ä¸»èœå• -->
    <div class="screen" id="menuScreen">
        <h1>ğŸ è¿›åŒ–è´ªåƒè›‡</h1>
        <div style="margin-bottom:20px; color:#666;">æœ€é«˜åˆ†: <span id="highScore">0</span></div>
        <button class="btn-main" onclick="openModeSelect()">å¼€å§‹æ¸¸æˆ</button>
        <button class="btn-main btn-sub" onclick="openShop()">ğŸ¨ çš®è‚¤å•†åº—</button>
    </div>

    <!-- æ¨¡å¼é€‰æ‹© -->
    <div class="screen hidden" id="modeScreen">
        <h2>é€‰æ‹©æ¨¡å¼</h2>
        <button class="btn-main" onclick="startGame('basic')" style="background:#81C784;">ğŸŸ¢ äº”åéŸ³åŸºç¡€</button>
        <button class="btn-main" onclick="startGame('word')" style="background:#FFB74D;">ğŸŸ¡ å•è¯å¬åŠ›</button>
        <button class="btn-main" onclick="startGame('sentence')" style="background:#E57373;">ğŸ”´ å¥å­æŒ‘æˆ˜</button>
        <button class="btn-main btn-sub" onclick="showScreen('menuScreen')">è¿”å›</button>
    </div>

    <!-- å•†åº— -->
    <div class="screen hidden" id="shopScreen">
        <h2>çš®è‚¤å•†åº— (ğŸ’°<span id="shopCoins">0</span>)</h2>
        <div class="shop-grid" id="shopGrid">
            <!-- JS å¡«å…… -->
        </div>
        <button class="btn-main btn-sub" onclick="showScreen('menuScreen')">è¿”å›</button>
    </div>

    <!-- ç»“ç®— -->
    <div class="screen hidden" id="overScreen">
        <h1 style="color:#E57373">GAME OVER</h1>
        <div style="font-size:24px; margin:10px;">å¾—åˆ†: <span id="finalScore">0</span></div>
        <div style="color:#FFC107; margin-bottom:20px;">è·å¾—é‡‘å¸: +<span id="earnedCoins">0</span></div>
        <button class="btn-main" onclick="openModeSelect()">å†ç©ä¸€æ¬¡</button>
        <button class="btn-main btn-sub" onclick="showScreen('menuScreen')">ä¸»èœå•</button>
    </div>

    <script>
        // ================= ğŸ’¾ æ•°æ®æŒä¹…åŒ– =================
        const DB = {
            coins: parseInt(localStorage.getItem('snake_coins') || 100),
            highScore: parseInt(localStorage.getItem('snake_high') || 0),
            unlockedSkins: JSON.parse(localStorage.getItem('snake_skins') || '["macaron"]'),
            currentSkin: localStorage.getItem('snake_cur_skin') || 'macaron',
            save: function() {
                localStorage.setItem('snake_coins', this.coins);
                localStorage.setItem('snake_high', this.highScore);
                localStorage.setItem('snake_skins', JSON.stringify(this.unlockedSkins));
                localStorage.setItem('snake_cur_skin', this.currentSkin);
            }
        };

        // ================= ğŸ¨ çš®è‚¤é…ç½® =================
        const SKINS = {
            macaron: { name: "é©¬å¡é¾™", price: 0, colors: ['#FF80AB', '#80D8FF', '#FFD180'], bg: '#FFF0F5' },
            morandi: { name: "è«å…°è¿ª", price: 200, colors: ['#8F9E9D', '#BCAAA4', '#E6C9A8'], bg: '#D7D2CC' },
            cyber:   { name: "èµ›åšæœ‹å…‹", price: 500, colors: ['#00FF00', '#FF00FF', '#00E5FF'], bg: '#050510', glow: true },
            dark:    { name: "æš—é»‘éœ“è™¹", price: 800, colors: ['#FF3D00', '#FFEA00', '#76FF03'], bg: '#121212', glow: true },
            anime:   { name: "äºŒæ¬¡å…ƒ", price: 1000, colors: ['#29B6F6', '#FFFFFF', '#FF4081'], bg: '#E1F5FE' },
            abstract:{ name: "æŠ½è±¡æ´¾", price: 1500, colors: ['#6200EA', '#00BFA5', '#D500F9'], bg: '#F3E5F5' },
            gold:    { name: "åœŸè±ªé‡‘", price: 3000, colors: ['#FFD700', '#FFECB3', '#FFA000'], bg: '#FFF8E1', glow: true }
        };

        // ================= ğŸ“š é¢˜åº“ =================
        const LEVELS = {
            basic: ['ã‚','ã„','ã†','ãˆ','ãŠ','ã‹','ã','ã','ã‘','ã“','ã•','ã—','ã™','ã›','ã','ãŸ','ã¡','ã¤','ã¦','ã¨','ãª','ã«','ã¬','ã­','ã®','ã¯','ã²','ãµ','ã¸','ã»','ã¾','ã¿','ã‚€','ã‚','ã‚‚','ã‚„','ã‚†','ã‚ˆ','ã‚‰','ã‚Š','ã‚‹','ã‚Œ','ã‚','ã‚','ã‚’','ã‚“'],
            word: [{q:'çŒ«',a:'ã­ã“'},{q:'çŠ¬',a:'ã„ã¬'},{q:'é³¥',a:'ã¨ã‚Š'},{q:'èŠ±',a:'ã¯ãª'},{q:'æœˆ',a:'ã¤ã'},{q:'é›¨',a:'ã‚ã‚'},{q:'æ¡œ',a:'ã•ãã‚‰'},{q:'é›ª',a:'ã‚†ã'},{q:'æ„›',a:'ã‚ã„'}],
            sentence: ["ã“ã‚“ã«ã¡ã¯", "ã‚ã‚ŠãŒã¨ã†", "ã™ã¿ã¾ã›ã‚“", "ãŠã‚„ã™ã¿", "ã‹ã‚ã„ã„"]
        };

        // ================= ğŸ® æ¸¸æˆå¼•æ“ =================
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const bgCanvas = document.getElementById('bgCanvas');
        const bgCtx = bgCanvas.getContext('2d');

        let W, H;
        let snake = [], path = [];
        let foods = [], particles = [];
        let angle = -Math.PI/2, targetAngle = -Math.PI/2;
        let speed = 3, baseSpeed = 3;
        let score = 0, fever = 0, isFever = false;
        let gameLoop, bgLoop;
        let mode = 'basic', levelQ = [], curTarget = null;
        let isPaused = true;
        let camShake = 0;

        // åˆå§‹åŒ–
        function init() {
            resize();
            window.addEventListener('resize', resize);
            updateUI();
            startBgAnim();
        }

        function resize() {
            W = window.innerWidth; H = window.innerHeight;
            canvas.width = W; canvas.height = H;
            bgCanvas.width = W; bgCanvas.height = H;
        }

        // ================= ğŸ•¹ï¸ é€»è¾‘æ§åˆ¶ =================
        function startGame(m) {
            mode = m;
            score = 0; fever = 0; isFever = false;
            snake = []; path = []; foods = []; particles = [];
            
            // åˆå§‹åŒ–è›‡
            let cx = W/2, cy = H/2;
            for(let i=0; i<50; i++) path.push({x: cx, y: cy + i*4});
            snake = [path[0], path[10], path[20]]; // åˆå§‹3èŠ‚
            
            angle = -Math.PI/2; targetAngle = angle;
            
            // é¢˜åº“å‡†å¤‡
            if(mode === 'basic') levelQ = [...LEVELS.basic];
            
            showScreen(null); // éšè—æ‰€æœ‰èœå•
            document.getElementById('hud').style.display = 'flex';
            document.getElementById('controls').style.display = 'flex';
            document.body.setAttribute('data-theme', DB.currentSkin);
            
            isPaused = false;
            nextTurn();
            loop();
        }

        function nextTurn() {
            // ç”Ÿæˆç›®æ ‡
            if(mode === 'basic') {
                if(levelQ.length === 0) { gameOver(); return; } // ç®€å•é€šå…³é€»è¾‘
                curTarget = { val: levelQ[0], type: 'char' };
                speak(curTarget.val);
            } else if (mode === 'word') {
                let item = LEVELS.word[Math.floor(Math.random()*LEVELS.word.length)];
                curTarget = { val: item.q, ans: item.a, type: 'word' };
                speak(item.ans);
            } else {
                // å¥å­é€»è¾‘ç®€åŒ–
                let s = LEVELS.sentence[Math.floor(Math.random()*LEVELS.sentence.length)];
                curTarget = { val: s.charAt(0), full: s, type: 'sent' }; // ç®€åŒ–æ¼”ç¤º
                speak(s);
            }
            
            document.getElementById('targetVal').innerText = curTarget.val;
            
            foods = [];
            // ç”Ÿæˆæ­£ç¡®é¡¹
            spawnFood(curTarget.val, true);
            // ç”Ÿæˆå¹²æ‰°é¡¹
            for(let i=0; i<4; i++) spawnFood(getRandomChar(), false);
            // ç”Ÿæˆé“å…· (10%æ¦‚ç‡)
            if(Math.random()<0.1) spawnFood('â­', false, 'coin');
            if(Math.random()<0.05) spawnFood('ğŸ’£', false, 'bomb');
        }

        function spawnFood(val, isTarget, type='normal') {
            let x, y, ok=false;
            while(!ok) {
                x = 20 + Math.random()*(W-40);
                y = 20 + Math.random()*(H-40);
                ok = true;
                if(Math.hypot(x-snake[0].x, y-snake[0].y) < 100) ok=false;
            }
            foods.push({x, y, val, isTarget, type, r: type==='normal'?15:18});
        }

        function loop() {
            if(isPaused) return;
            update();
            draw();
            gameLoop = requestAnimationFrame(loop);
        }

        function update() {
            // 1. è§’åº¦å¹³æ»‘
            let diff = targetAngle - angle;
            while(diff <= -Math.PI) diff += Math.PI*2;
            while(diff > Math.PI) diff -= Math.PI*2;
            angle += diff * 0.15;

            // 2. é€Ÿåº¦ä¸ç‹‚çƒ­
            let currSpeed = isFever ? baseSpeed * 2 : (isBoosting ? baseSpeed * 1.5 : baseSpeed);
            if(isFever) {
                fever -= 0.5;
                if(fever <= 0) { isFever = false; document.body.classList.remove('fever-active'); }
            }
            document.getElementById('feverBar').style.width = fever + '%';

            // 3. ç§»åŠ¨
            let head = { x: snake[0].x + Math.cos(angle)*currSpeed, y: snake[0].y + Math.sin(angle)*currSpeed };
            
            // è¾¹ç•Œåå¼¹
            if(head.x<10 || head.x>W-10) { angle = Math.PI - angle; targetAngle = angle; head.x = Math.max(10, Math.min(W-10, head.x)); }
            if(head.y<10 || head.y>H-10) { angle = -angle; targetAngle = angle; head.y = Math.max(10, Math.min(H-10, head.y)); }

            path.unshift(head);
            if(path.length > (snake.length * 8) + 50) path.pop();

            // æ›´æ–°èº«ä½“
            snake[0] = head;
            for(let i=1; i<snake.length; i++) {
                let idx = i * (isFever || isBoosting ? 4 : 8);
                if(idx < path.length) snake[i] = path[idx];
            }

            // 4. ç¢°æ’æ£€æµ‹
            checkCollisions(head);
            
            // 5. ç²’å­æ›´æ–°
            updateParticles();
            
            // 6. éœ‡åŠ¨è¡°å‡
            if(camShake > 0) camShake *= 0.9;
        }

        function checkCollisions(head) {
            // åƒé£Ÿç‰©
            for(let i=foods.length-1; i>=0; i--) {
                let f = foods[i];
                if(Math.hypot(head.x-f.x, head.y-f.y) < f.r + 10) {
                    handleEat(f, i);
                }
            }
            // æ’è‡ªå·± (Feveræ¨¡å¼æ— æ•Œ)
            if(!isFever) {
                for(let i=10; i<snake.length; i++) {
                    if(Math.hypot(head.x-snake[i].x, head.y-snake[i].y) < 8) {
                        gameOver();
                    }
                }
            }
        }

        function handleEat(f, idx) {
            createExplosion(f.x, f.y, f.isTarget ? '#FFEB3B' : '#CCC');
            foods.splice(idx, 1);

            if(f.type === 'coin') {
                score += 50; DB.coins += 10;
                playSound('coin'); showToast("ğŸ’° é‡‘å¸ +10");
                return;
            }
            if(f.type === 'bomb') {
                // æ¸…é™¤æ‰€æœ‰é”™è¯¯é¡¹
                foods = foods.filter(fd => fd.isTarget || fd.type !== 'normal');
                playSound('boom'); camShake = 10; showToast("ğŸ’£ æ¸…åœº!");
                return;
            }

            if(f.isTarget) {
                score += 10;
                fever = Math.min(100, fever + 20);
                if(fever >= 100 && !isFever) {
                    isFever = true; document.body.classList.add('fever-active');
                    playSound('fever'); showToast("ğŸ”¥ FEVER TIME!");
                } else {
                    playSound('eat');
                }
                
                // å˜é•¿
                snake.push({x:-100, y:-100});
                
                // é€»è¾‘æ¨è¿›
                if(mode==='basic') levelQ.shift();
                nextTurn();
            } else {
                score = Math.max(0, score-5);
                fever = 0;
                playSound('wrong'); camShake = 5;
                if(snake.length > 3) snake.pop();
                else gameOver();
                spawnFood(getRandomChar(), false);
            }
            updateUI();
        }

        // ================= ğŸ¨ æ¸²æŸ“ç³»ç»Ÿ =================
        function draw() {
            ctx.clearRect(0, 0, W, H);
            
            // éœ‡åŠ¨æ•ˆæœ
            ctx.save();
            if(camShake > 0.5) {
                ctx.translate((Math.random()-0.5)*camShake, (Math.random()-0.5)*camShake);
            }

            // 1. ç”»é£Ÿç‰©
            foods.forEach(f => {
                let color = f.isTarget ? SKINS[DB.currentSkin].colors[0] : '#999';
                if(f.type === 'coin') color = '#FFD700';
                if(f.type === 'bomb') color = '#333';

                ctx.save();
                ctx.translate(f.x, f.y);
                // å‘¼å¸æ•ˆæœ
                let scale = 1 + Math.sin(Date.now()/200)*0.1;
                ctx.scale(scale, scale);
                
                ctx.beginPath();
                ctx.arc(0, 0, f.r, 0, Math.PI*2);
                ctx.fillStyle = color;
                
                // éœ“è™¹å…‰æ•ˆ
                if(SKINS[DB.currentSkin].glow) {
                    ctx.shadowBlur = 15; ctx.shadowColor = color;
                }
                ctx.fill();
                ctx.shadowBlur = 0;

                ctx.fillStyle = f.type==='bomb'?'#FFF':'#FFF';
                ctx.font = "bold 14px Arial";
                ctx.textAlign = "center"; ctx.textBaseline = "middle";
                ctx.fillText(f.val, 0, 1);
                ctx.restore();
            });

            // 2. ç”»è›‡
            let skin = SKINS[DB.currentSkin];
            let colors = skin.colors;
            
            // èº«ä½“
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            
            // ç»˜åˆ¶è·¯å¾„è¿çº¿ (ä½¿èº«ä½“æ›´è¿è´¯)
            if(path.length > 1) {
                // è¿™é‡Œä¸ºäº†æ€§èƒ½å’Œæ•ˆæœï¼Œæˆ‘ä»¬è¿˜æ˜¯ç”¨åœ†çƒç»˜åˆ¶ï¼Œä½†æ›´ç´§å¯†
            }

            for(let i=snake.length-1; i>=0; i--) {
                let p = snake[i];
                let isHead = i===0;
                let c = colors[i % colors.length];
                
                ctx.beginPath();
                let r = isHead ? 12 : 10;
                if(isFever) r += 2; // ç‹‚çƒ­å˜å¤§

                ctx.arc(p.x, p.y, r, 0, Math.PI*2);
                ctx.fillStyle = c;
                if(skin.glow) { ctx.shadowBlur = 10; ctx.shadowColor = c; }
                ctx.fill();
                ctx.shadowBlur = 0;

                // çœ¼ç›
                if(isHead) {
                    ctx.fillStyle = "white";
                    let ex = Math.cos(angle-0.5)*5, ey = Math.sin(angle-0.5)*5;
                    ctx.beginPath(); ctx.arc(p.x+ex, p.y+ey, 3, 0, Math.PI*2); ctx.fill();
                    ex = Math.cos(angle+0.5)*5; ey = Math.sin(angle+0.5)*5;
                    ctx.beginPath(); ctx.arc(p.x+ex, p.y+ey, 3, 0, Math.PI*2); ctx.fill();
                }
            }

            // 3. ç²’å­
            particles.forEach(p => {
                ctx.globalAlpha = p.life;
                ctx.fillStyle = p.color;
                ctx.beginPath(); ctx.arc(p.x, p.y, p.size, 0, Math.PI*2); ctx.fill();
            });
            ctx.globalAlpha = 1;
            ctx.restore();
        }

        // åŠ¨æ€èƒŒæ™¯
        function startBgAnim() {
            let offset = 0;
            function loop() {
                offset += 0.5;
                bgCtx.clearRect(0, 0, W, H);
                bgCtx.strokeStyle = "rgba(0,0,0,0.05)";
                bgCtx.lineWidth = 1;
                
                // ç”»ç½‘æ ¼
                if(DB.currentSkin === 'cyber' || DB.currentSkin === 'dark') bgCtx.strokeStyle = "rgba(0,255,0,0.1)";

                bgCtx.beginPath();
                for(let x=offset%30; x<W; x+=30) { bgCtx.moveTo(x,0); bgCtx.lineTo(x,H); }
                for(let y=offset%30; y<H; y+=30) { bgCtx.moveTo(0,y); bgCtx.lineTo(W,y); }
                bgCtx.stroke();
                
                requestAnimationFrame(loop);
            }
            loop();
        }

        // ================= âœ¨ ç‰¹æ•ˆç³»ç»Ÿ =================
        function createExplosion(x, y, color) {
            for(let i=0; i<15; i++) {
                particles.push({
                    x: x, y: y,
                    vx: (Math.random()-0.5)*10,
                    vy: (Math.random()-0.5)*10,
                    life: 1.0, size: Math.random()*4+2,
                    color: color
                });
            }
        }
        function updateParticles() {
            for(let i=particles.length-1; i>=0; i--) {
                let p = particles[i];
                p.x += p.vx; p.y += p.vy;
                p.life -= 0.05;
                if(p.life <= 0) particles.splice(i, 1);
            }
        }

        // ================= ğŸ”Š éŸ³é¢‘ç³»ç»Ÿ (Web Audio) =================
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSound(type) {
            if(audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain); gain.connect(audioCtx.destination);
            
            const now = audioCtx.currentTime;
            if(type === 'eat') {
                osc.type = 'sine';
                osc.frequency.setValueAtTime(600, now);
                osc.frequency.exponentialRampToValueAtTime(1000, now+0.1);
                gain.gain.setValueAtTime(0.1, now);
                gain.gain.linearRampToValueAtTime(0, now+0.1);
                osc.start(); osc.stop(now+0.1);
            } else if (type === 'coin') {
                osc.type = 'square';
                osc.frequency.setValueAtTime(1200, now);
                osc.frequency.setValueAtTime(1800, now+0.1);
                gain.gain.setValueAtTime(0.05, now);
                gain.gain.linearRampToValueAtTime(0, now+0.2);
                osc.start(); osc.stop(now+0.2);
            } else if (type === 'fever') {
                // æ¿€æ˜‚çš„å’Œå¼¦
                [440, 554, 659].forEach(f => {
                    let o = audioCtx.createOscillator();
                    let g = audioCtx.createGain();
                    o.connect(g); g.connect(audioCtx.destination);
                    o.type = 'sawtooth';
                    o.frequency.value = f;
                    g.gain.setValueAtTime(0.05, now);
                    g.gain.linearRampToValueAtTime(0, now+1);
                    o.start(); o.stop(now+1);
                });
            } else if (type === 'boom') {
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(100, now);
                osc.frequency.exponentialRampToValueAtTime(10, now+0.3);
                gain.gain.setValueAtTime(0.2, now);
                gain.gain.linearRampToValueAtTime(0, now+0.3);
                osc.start(); osc.stop(now+0.3);
            } else {
                // wrong
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(150, now);
                osc.frequency.linearRampToValueAtTime(50, now+0.3);
                gain.gain.setValueAtTime(0.1, now);
                gain.gain.linearRampToValueAtTime(0, now+0.3);
                osc.start(); osc.stop(now+0.3);
            }
        }

        // ================= ğŸ“± UI äº¤äº’ =================
        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
            if(id) document.getElementById(id).classList.remove('hidden');
        }
        function openModeSelect() { showScreen('modeScreen'); }
        function openShop() {
            showScreen('shopScreen');
            renderShop();
        }
        function pauseGame() { isPaused = true; showScreen('menuScreen'); }
        function gameOver() {
            isPaused = true;
            document.getElementById('finalScore').innerText = score;
            let earned = Math.floor(score / 10);
            document.getElementById('earnedCoins').innerText = earned;
            DB.coins += earned;
            if(score > DB.highScore) DB.highScore = score;
            DB.save();
            showScreen('overScreen');
        }
        function updateUI() {
            document.getElementById('scoreVal').innerText = score;
            document.getElementById('coinVal').innerText = DB.coins;
            document.getElementById('highScore').innerText = DB.highScore;
            document.getElementById('shopCoins').innerText = DB.coins;
        }

        function renderShop() {
            const grid = document.getElementById('shopGrid');
            grid.innerHTML = '';
            for(let key in SKINS) {
                let s = SKINS[key];
                let unlocked = DB.unlockedSkins.includes(key);
                let active = DB.currentSkin === key;
                
                let card = document.createElement('div');
                card.className = `skin-card ${active?'active':''} ${!unlocked?'locked':''}`;
                card.onclick = () => buyOrEquip(key);
                
                let preview = document.createElement('div');
                preview.className = 'skin-preview';
                preview.style.background = `linear-gradient(45deg, ${s.colors[0]}, ${s.colors[1]})`;
                
                let name = document.createElement('div');
                name.innerText = s.name;
                
                let price = document.createElement('div');
                price.className = 'price-tag';
                price.innerText = unlocked ? (active ? 'ä½¿ç”¨ä¸­' : 'å·²æ‹¥æœ‰') : `ğŸ’° ${s.price}`;
                if(active) price.style.background = '#4CAF50';
                
                card.append(preview, name, price);
                grid.appendChild(card);
            }
        }

        function buyOrEquip(key) {
            if(DB.unlockedSkins.includes(key)) {
                DB.currentSkin = key;
                DB.save();
                renderShop();
                playSound('eat');
            } else {
                let price = SKINS[key].price;
                if(DB.coins >= price) {
                    DB.coins -= price;
                    DB.unlockedSkins.push(key);
                    DB.currentSkin = key;
                    DB.save();
                    renderShop();
                    updateUI();
                    playSound('fever');
                    showToast("è§£é”æˆåŠŸ!");
                } else {
                    showToast("é‡‘å¸ä¸è¶³!");
                    playSound('wrong');
                }
            }
        }

        function showToast(msg) {
            let t = document.getElementById('toast');
            t.innerText = msg; t.classList.add('show');
            setTimeout(()=>t.classList.remove('show'), 1500);
        }

        // æ‘‡æ†é€»è¾‘
        let isBoosting = false;
        const stick = document.getElementById('stick');
        const joy = document.getElementById('joystick');
        let drag = false;
        
        const handleMove = (x, y, rect) => {
            let dx = x - (rect.left + rect.width/2);
            let dy = y - (rect.top + rect.height/2);
            let ang = Math.atan2(dy, dx);
            let dist = Math.min(Math.sqrt(dx*dx+dy*dy), 40);
            stick.style.transform = `translate(${Math.cos(ang)*dist}px, ${Math.sin(ang)*dist}px)`;
            targetAngle = ang;
        };

        joy.addEventListener('mousedown', () => drag=true);
        window.addEventListener('mouseup', () => { drag=false; stick.style.transform='none'; });
        window.addEventListener('mousemove', e => { if(drag) handleMove(e.clientX, e.clientY, joy.getBoundingClientRect()); });
        
        joy.addEventListener('touchstart', e => { drag=true; handleMove(e.touches[0].clientX, e.touches[0].clientY, joy.getBoundingClientRect()); });
        joy.addEventListener('touchmove', e => { if(drag) handleMove(e.touches[0].clientX, e.touches[0].clientY, joy.getBoundingClientRect()); });
        joy.addEventListener('touchend', () => { drag=false; stick.style.transform='none'; });

        document.getElementById('boostBtn').addEventListener('touchstart', (e)=>{e.preventDefault(); isBoosting=true;});
        document.getElementById('boostBtn').addEventListener('touchend', (e)=>{e.preventDefault(); isBoosting=false;});
        document.getElementById('boostBtn').addEventListener('mousedown', ()=>isBoosting=true);
        document.getElementById('boostBtn').addEventListener('mouseup', ()=>isBoosting=false);

        // è¾…åŠ©
        function getRandomChar() { return LEVELS.basic[Math.floor(Math.random()*LEVELS.basic.length)]; }
        function speak(t) { 
            let u = new SpeechSynthesisUtterance(t); 
            u.lang='ja-JP'; u.rate=1.2; 
            window.speechSynthesis.cancel();
            window.speechSynthesis.speak(u); 
        }

        init();
    </script>
</body>
</html>
