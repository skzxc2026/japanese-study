<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<<<<<<< Updated upstream
    <title>æ—¥è¯­å¬éŸ³è¾¨ä½</title>
    <style>
        body {
            margin: 0;
            background: #1a1a2e;
=======
    <title>æ—¥è¯­èŠ‚å¥å¤§å¸ˆ</title>
    <style>
        body {
            margin: 0;
            background: #111;
>>>>>>> Stashed changes
            color: white;
            font-family: "Microsoft YaHei", sans-serif;
            overflow: hidden;
            touch-action: none;
            user-select: none;
        }

<<<<<<< Updated upstream
        canvas { display: block; width: 100%; height: 100%; }

=======
        /* æ¸¸æˆç”»å¸ƒ */
        canvas {
            display: block;
            width: 100%;
            height: 100%;
        }

        /* ç•Œé¢ UI */
>>>>>>> Stashed changes
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            display: flex; flex-direction: column; justify-content: space-between;
        }

        .top-bar {
            padding: 20px;
            display: flex; justify-content: space-between;
            background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent);
<<<<<<< Updated upstream
            font-size: 1.5rem; font-weight: bold; text-shadow: 0 0 10px #e94560;
        }

        /* åˆ¤å®šçº¿ */
        #judgment-line-visual {
            position: absolute;
            bottom: 15%; 
            width: 100%;
            height: 4px;
            background: rgba(233, 69, 96, 0.8);
            box-shadow: 0 0 20px rgba(233, 69, 96, 1);
        }
        /* åˆ¤å®šçº¿æ–‡å­—æç¤º */
        #judgment-line-visual::after {
            content: "åœ¨æ­¤çº¿ä¹‹å‰ç‚¹å‡»";
            position: absolute; right: 10px; bottom: 10px;
            color: rgba(255,255,255,0.5); font-size: 0.8rem;
        }

        #menu-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(26, 26, 46, 0.95);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 100; pointer-events: auto;
        }

        .title { font-size: 2.5rem; color: #e94560; margin-bottom: 10px; font-weight: bold; }
        .subtitle { color: #aaa; margin-bottom: 40px; font-size: 1rem; }
        
        .btn {
            background: #e94560;
            color: white; border: none; padding: 15px 60px;
            font-size: 1.5rem; border-radius: 50px;
            cursor: pointer; box-shadow: 0 5px 15px rgba(233, 69, 96, 0.4);
            font-weight: bold;
        }

        .hit-feedback {
            position: absolute; left: 50%; top: 60%;
            transform: translate(-50%, -50%);
            font-size: 4rem; font-weight: 900;
            opacity: 0; pointer-events: none;
            text-shadow: 0 0 20px rgba(255,255,255,0.8);
        }
        
        .perfect { color: #ffd700; animation: popFade 0.4s forwards; }
        .miss { color: #ff4757; animation: shakeFade 0.4s forwards; }
=======
            font-size: 1.5rem; font-weight: bold; text-shadow: 0 0 10px #00d2ff;
        }

        /* åˆ¤å®šçº¿æç¤º */
        #judgment-line-visual {
            position: absolute;
            bottom: 15%; /* å¯¹åº”ä»£ç ä¸­çš„åˆ¤å®šä½ç½® */
            width: 100%;
            height: 2px;
            background: rgba(255, 255, 255, 0.3);
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
        }

        /* èœå•é®ç½© */
        #menu-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 100; pointer-events: auto;
            backdrop-filter: blur(5px);
        }

        .title { font-size: 2.5rem; color: #00d2ff; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 5px; }
        .subtitle { color: #aaa; margin-bottom: 40px; font-size: 1rem; }
        
        .btn {
            background: linear-gradient(45deg, #00d2ff, #007aff);
            color: white; border: none; padding: 15px 60px;
            font-size: 1.5rem; border-radius: 50px;
            cursor: pointer; box-shadow: 0 0 20px rgba(0, 210, 255, 0.4);
            font-weight: bold; transition: transform 0.1s;
        }
        .btn:active { transform: scale(0.95); }

        /* åˆ¤å®šç‰¹æ•ˆæ–‡å­— */
        .hit-feedback {
            position: absolute;
            left: 50%; top: 60%;
            transform: translate(-50%, -50%);
            font-size: 3rem; font-weight: 900;
            opacity: 0;
            pointer-events: none;
            text-shadow: 0 0 20px rgba(255,255,255,0.8);
        }
        
        .perfect { color: #ffeb3b; animation: popFade 0.5s forwards; }
        .good { color: #00e676; animation: popFade 0.5s forwards; }
        .miss { color: #ff1744; animation: shakeFade 0.5s forwards; }
>>>>>>> Stashed changes

        @keyframes popFade { 0% { opacity: 0; transform: translate(-50%, -30%) scale(0.5); } 50% { opacity: 1; transform: translate(-50%, -50%) scale(1.2); } 100% { opacity: 0; transform: translate(-50%, -60%) scale(1); } }
        @keyframes shakeFade { 0% { transform: translate(-55%, -50%); opacity: 1; } 25% { transform: translate(-45%, -50%); } 50% { transform: translate(-50%, -50%); opacity: 1; } 100% { transform: translate(-50%, -40%); opacity: 0; } }

<<<<<<< Updated upstream
=======
        /* çº¢å±è­¦å‘Š */
>>>>>>> Stashed changes
        #damage-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: red; opacity: 0; pointer-events: none; transition: opacity 0.1s;
        }
    </style>
</head>
<body>

    <div id="damage-overlay"></div>
    <div id="judgment-line-visual"></div>

    <div id="ui-layer">
        <div class="top-bar">
<<<<<<< Updated upstream
            <div id="score-display">å¾—åˆ†: 0</div>
            <div id="bpm-display">é€Ÿåº¦: Lv.1</div>
=======
            <div id="score-display">SCORE: 0</div>
            <div id="combo-display">COMBO: 0</div>
>>>>>>> Stashed changes
        </div>
        <div id="feedback-container"></div>
    </div>

    <div id="menu-layer">
<<<<<<< Updated upstream
        <div class="title">ğŸ‘‚ å¬éŸ³è¾¨ä½</div>
        <div class="subtitle">å¬åˆ°å‡ååï¼Œåœ¨æ‰è½åˆ°åº•éƒ¨å‰ç‚¹å‡»å®ƒ</div>
        <p style="color:#888; margin-bottom: 20px;">è¶…æ…¢é€Ÿå…¥é—¨ç‰ˆ</p>
        <button class="btn" onclick="initAudioAndStart()">å¼€å§‹ç»ƒä¹ </button>
=======
        <div class="title">Rhythm Kana</div>
        <div class="subtitle">æ—¥è¯­èŠ‚å¥å¤§å¸ˆ - éŸ³ä¹åŒæ­¥ç‰ˆ</div>
        <p style="color:#888; margin-bottom: 20px;">æˆ´ä¸Šè€³æœºä½“éªŒæœ€ä½³ | ç‚¹å‡»åº•éƒ¨åˆ¤å®šçº¿</p>
        <button class="btn" onclick="initAudioAndStart()">START</button>
>>>>>>> Stashed changes
    </div>

    <canvas id="gameCanvas"></canvas>

<script>
<<<<<<< Updated upstream
    // === 1. éŸ³é¢‘å¼•æ“ ===
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    let nextNoteTime = 0;
    let beatCount = 0;
    let isPlaying = false;
    
    // === éš¾åº¦é…ç½® (ææ…¢é€Ÿ) ===
    let bpm = 10;       // åˆå§‹ BPM 10 (æ¯6ç§’ä¸€ä¸ªè¯)
    let speed = 1.0;    // åˆå§‹ä¸‹è½é€Ÿåº¦ (åƒç´ /å¸§)ï¼Œéå¸¸æ…¢
    let level = 1;
    
=======
    // === 1. éŸ³é¢‘å¼•æ“ (Web Audio API) ===
    // è‡ªåŠ¨ç”ŸæˆBGMå’ŒéŸ³æ•ˆï¼Œæ— éœ€å¤–éƒ¨æ–‡ä»¶
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    let bgmOscillators = [];
    let nextNoteTime = 0;
    let beatCount = 0;
    let isPlaying = false;
    let bpm = 100; // åˆå§‹ BPM
    
    // ç®€å•çš„åˆæˆå™¨éŸ³æ•ˆ
>>>>>>> Stashed changes
    function playSound(type) {
        if (audioCtx.state === 'suspended') audioCtx.resume();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        const now = audioCtx.currentTime;

        if (type === 'perfect') {
<<<<<<< Updated upstream
            osc.type = 'sine';
            osc.frequency.setValueAtTime(880, now); // A5
            gain.gain.setValueAtTime(0.2, now);
            gain.gain.exponentialRampToValueAtTime(0.01, now + 0.5);
            osc.start(now); osc.stop(now + 0.5);
        } else if (type === 'miss') {
            osc.type = 'sawtooth';
            osc.frequency.setValueAtTime(100, now);
            osc.frequency.linearRampToValueAtTime(50, now + 0.3);
            gain.gain.setValueAtTime(0.2, now);
            gain.gain.linearRampToValueAtTime(0, now + 0.3);
            osc.start(now); osc.stop(now + 0.3);
        }
    }

    function speakKana(text) {
        if ('speechSynthesis' in window) {
            window.speechSynthesis.cancel(); // æ‰“æ–­ä¹‹å‰çš„
            const u = new SpeechSynthesisUtterance(text);
            u.lang = 'ja-JP';
            u.rate = 1.0; // æ­£å¸¸è¯­é€Ÿ
            u.volume = 1.0;
=======
            // é’¢ç´é«˜éŸ³ C6
            osc.type = 'triangle';
            osc.frequency.setValueAtTime(1046.50, now);
            gain.gain.setValueAtTime(0.3, now);
            gain.gain.exponentialRampToValueAtTime(0.01, now + 0.4);
            osc.start(now); osc.stop(now + 0.4);
        } else if (type === 'good') {
            // é’¢ç´ä¸­éŸ³ C5
            osc.type = 'triangle';
            osc.frequency.setValueAtTime(523.25, now);
            gain.gain.setValueAtTime(0.3, now);
            gain.gain.exponentialRampToValueAtTime(0.01, now + 0.3);
            osc.start(now); osc.stop(now + 0.3);
        } else if (type === 'miss') {
            // å™ªéŸ³
            osc.type = 'sawtooth';
            osc.frequency.setValueAtTime(100, now);
            osc.frequency.linearRampToValueAtTime(50, now + 0.2);
            gain.gain.setValueAtTime(0.2, now);
            gain.gain.linearRampToValueAtTime(0, now + 0.2);
            osc.start(now); osc.stop(now + 0.2);
        }
    }

    // æœ—è¯»å‡å (TTS)
    function speakKana(text) {
        if ('speechSynthesis' in window) {
            const u = new SpeechSynthesisUtterance(text);
            u.lang = 'ja-JP';
            u.rate = 1.5; // è¯­é€Ÿå¿«ä¸€ç‚¹ï¼Œé€‚åº”èŠ‚å¥
            u.volume = 0.8;
>>>>>>> Stashed changes
            window.speechSynthesis.speak(u);
        }
    }

<<<<<<< Updated upstream
    function scheduleAudio() {
        const lookahead = 0.1;
        const secondsPerBeat = 60.0 / bpm;

        while (nextNoteTime < audioCtx.currentTime + lookahead) {
            // ç”Ÿæˆæ–¹å— (BPMå¾ˆä½ï¼Œæ‰€ä»¥æ¯ä¸ªèŠ‚æ‹éƒ½ç”Ÿæˆï¼Œä¸ç„¶ç­‰å¾…æ—¶é—´å¤ªé•¿)
            spawnTileOnBeat(beatCount); 
=======
    // èŠ‚å¥è°ƒåº¦å™¨ (Metronome)
    function scheduleAudio() {
        const lookahead = 0.1; // é¢„è¯»æ—¶é—´
        const secondsPerBeat = 60.0 / bpm;

        while (nextNoteTime < audioCtx.currentTime + lookahead) {
            playBeat(nextNoteTime, beatCount);
            // è¿™é‡Œè§¦å‘æ¸¸æˆé€»è¾‘ç”Ÿæˆæ–¹å—ï¼Œä¿è¯ç»å¯¹åŒæ­¥
            spawnTileOnBeat(beatCount); 
            
>>>>>>> Stashed changes
            nextNoteTime += secondsPerBeat;
            beatCount++;
        }
        if (isPlaying) requestAnimationFrame(scheduleAudio);
    }

<<<<<<< Updated upstream
    // === 2. æ¸¸æˆé€»è¾‘ ===
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    
=======
    function playBeat(time, beat) {
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain);
        gain.connect(audioCtx.destination);

        // ç®€å•çš„é¼“ç‚¹é€»è¾‘ï¼šåŠ¨ æ¬¡ æ‰“ æ¬¡
        if (beat % 4 === 0) {
            // Kick (é‡éŸ³)
            osc.frequency.setValueAtTime(150, time);
            osc.frequency.exponentialRampToValueAtTime(0.01, time + 0.5);
            gain.gain.setValueAtTime(0.5, time);
            gain.gain.exponentialRampToValueAtTime(0.01, time + 0.5);
        } else {
            // Hi-hat (è½»éŸ³)
            osc.type = 'square';
            osc.frequency.setValueAtTime(800, time); // é«˜é¢‘
            gain.gain.setValueAtTime(0.1, time);
            gain.gain.exponentialRampToValueAtTime(0.01, time + 0.05);
        }

        osc.start(time);
        osc.stop(time + 0.5);
    }

    // === 2. æ¸¸æˆæ ¸å¿ƒé€»è¾‘ ===
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    
    // å‡åæ± 
>>>>>>> Stashed changes
    const KANA_SETS = [
        ['ã‚','ã„','ã†','ãˆ','ãŠ'],
        ['ã‹','ã','ã','ã‘','ã“'],
        ['ã•','ã—','ã™','ã›','ã'],
        ['ãŸ','ã¡','ã¤','ã¦','ã¨'],
        ['ãª','ã«','ã¬','ã­','ã®']
    ];

<<<<<<< Updated upstream
    const LANES = 4;
    let laneWidth = 0;
    let judgmentLineY = 0;
    let tiles = [];
    let score = 0;
=======
    // é…ç½®
    const LANES = 4;
    let laneWidth = 0;
    let judgmentLineY = 0; // åˆ¤å®šçº¿Yåæ ‡
    let tiles = [];
    let score = 0;
    let combo = 0;
    let speed = 5; // åƒç´ /å¸§ (éšBPMåŠ¨æ€è°ƒæ•´)
>>>>>>> Stashed changes
    let isGameOver = false;

    function resize() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        laneWidth = canvas.width / LANES;
<<<<<<< Updated upstream
        judgmentLineY = canvas.height * 0.85; 
=======
        judgmentLineY = canvas.height * 0.85; // åˆ¤å®šçº¿åœ¨å±å¹• 85% å¤„
        
        // æ›´æ–°CSSè§†è§‰çº¿ä½ç½®
>>>>>>> Stashed changes
        document.getElementById('judgment-line-visual').style.bottom = '15%';
    }
    window.addEventListener('resize', resize);
    resize();

    function initAudioAndStart() {
        if (audioCtx.state === 'suspended') audioCtx.resume();
        document.getElementById('menu-layer').style.display = 'none';
        
<<<<<<< Updated upstream
        tiles = [];
        score = 0;
        beatCount = 0;
        
        // é‡ç½®ä¸ºæç®€éš¾åº¦
        bpm = 10; 
        speed = 1.0; 
        level = 1;
        updateHUD();
        
        isPlaying = true;
        nextNoteTime = audioCtx.currentTime + 0.5;
        isGameOver = false;
        
        scheduleAudio();
        gameLoop();
    }

    function spawnTileOnBeat(beat) {
        // éšæœºé€‰æ‹©è½¨é“å’Œå‡å
        const lane = Math.floor(Math.random() * LANES);
        const set = KANA_SETS[Math.floor(Math.random() * KANA_SETS.length)];
        const char = set[Math.floor(Math.random() * set.length)];
        
        // ã€æ ¸å¿ƒä¿®æ”¹ã€‘ç”Ÿæˆç¬é—´ç«‹å³æœ—è¯»
        speakKana(char);

        tiles.push({
            lane: lane,
            y: -150, // ä»å±å¹•ä¸Šæ–¹å¤–å¼€å§‹
            char: char,
            width: laneWidth,
            height: 150,
            active: true,
            color: '#16213e'
        });
        
        // ã€æ ¸å¿ƒä¿®æ”¹ã€‘æç¼“æ…¢çš„éš¾åº¦é€’å¢
        // æ¯ç”Ÿæˆ 5 ä¸ªè¯ï¼Œæ£€æŸ¥ä¸€æ¬¡
        if (beat > 0 && beat % 5 === 0) {
            // é€Ÿåº¦ä¸Šé™é™åˆ¶åœ¨ 4.0 (ä¾ç„¶ä¸ç®—å¿«)
            if (speed < 4.0) {
                bpm += 1;       // BPM +1
                speed += 0.1;   // é€Ÿåº¦ +0.1
                level++;
                updateHUD();
            }
        }
    }

    function updateHUD() {
        document.getElementById('bpm-display').innerText = `é€Ÿåº¦: Lv.${level}`;
=======
        // é‡ç½®çŠ¶æ€
        tiles = [];
        score = 0;
        combo = 0;
        beatCount = 0;
        bpm = 100; // åˆå§‹é€Ÿåº¦
        speed = (canvas.height * 0.85) / (60 * (60/bpm) * 4); // ç²—ç•¥è®¡ç®—é€Ÿåº¦ä»¥åŒ¹é…èŠ‚æ‹
        // å®é™…ä¸Šä¸ºäº†æ¸¸æˆæ€§ï¼Œæˆ‘ä»¬è®©é€Ÿåº¦å›ºå®šï¼Œç”Ÿæˆé¢‘ç‡éšBPM
        speed = canvas.height / 200; 

        isPlaying = true;
        nextNoteTime = audioCtx.currentTime + 0.5; // å»¶è¿Ÿä¸€ç‚¹å¼€å§‹
        isGameOver = false;
        
        scheduleAudio(); // å¯åŠ¨éŸ³é¢‘å¼•æ“
        gameLoop();      // å¯åŠ¨æ¸²æŸ“å¾ªç¯
    }

    // åœ¨èŠ‚æ‹ä¸Šç”Ÿæˆæ–¹å—
    function spawnTileOnBeat(beat) {
        // å¹¶ä¸æ˜¯æ¯ä¸ªèŠ‚æ‹éƒ½ç”Ÿæˆï¼Œç•™ç‚¹ç©ºéš™æ›´æœ‰èŠ‚å¥æ„Ÿ
        // éšæœºé€»è¾‘ï¼š70% æ¦‚ç‡ç”Ÿæˆ
        if (Math.random() > 0.3) {
            const lane = Math.floor(Math.random() * LANES);
            // é¿å…åŒä¸€è¡Œé‡å ï¼ˆè™½ç„¶è¿™é‡Œæ˜¯å•çº¿ç¨‹ç”Ÿæˆï¼Œä½†ä¸ºäº†é€»è¾‘ä¸¥è°¨ï¼‰
            const set = KANA_SETS[Math.floor(Math.random() * KANA_SETS.length)];
            const char = set[Math.floor(Math.random() * set.length)];
            
            tiles.push({
                lane: lane,
                y: -150, // ä»å±å¹•ä¸Šæ–¹ç”Ÿæˆ
                char: char,
                width: laneWidth,
                height: 150, // ç´é”®é«˜åº¦
                active: true,
                color: '#fff' // é»˜è®¤ç™½è‰²
            });
        }
        
        // éš¾åº¦é€’å¢ï¼šæ¯16æ‹æ£€æŸ¥ä¸€æ¬¡
        if (beat % 16 === 0) {
            bpm += 2; // åŠ å¿«BPM
            speed += 0.2; // åŠ å¿«ä¸‹è½é€Ÿåº¦
        }
>>>>>>> Stashed changes
    }

    function update() {
        if (!isPlaying || isGameOver) return;

<<<<<<< Updated upstream
=======
        // ç§»åŠ¨æ–¹å—
>>>>>>> Stashed changes
        tiles.forEach(t => {
            t.y += speed;
        });

<<<<<<< Updated upstream
        // æ£€æŸ¥ Miss (å®Œå…¨æ‰å‡ºå±å¹•ä¸‹æ–¹)
=======
        // æ£€æŸ¥ Miss (æ‰å‡ºå±å¹•)
>>>>>>> Stashed changes
        tiles.forEach(t => {
            if (t.active && t.y > canvas.height) {
                t.active = false;
                handleMiss();
            }
        });

<<<<<<< Updated upstream
=======
        // æ¸…ç†
>>>>>>> Stashed changes
        tiles = tiles.filter(t => t.y < canvas.height + 200);
    }

    function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);

<<<<<<< Updated upstream
        // è½¨é“çº¿
        ctx.strokeStyle = 'rgba(255,255,255,0.05)';
        ctx.lineWidth = 2;
        for (let i = 1; i < LANES; i++) {
            ctx.beginPath(); ctx.moveTo(i * laneWidth, 0); ctx.lineTo(i * laneWidth, canvas.height); ctx.stroke();
        }

        tiles.forEach(t => {
            const x = t.lane * laneWidth;
            
            // ç»˜åˆ¶æ–¹å—
            ctx.fillStyle = t.active ? t.color : '#333';
            if (!t.active && t.color === '#ffd700') ctx.fillStyle = '#ffd700'; // ä¿æŒé‡‘è‰²

            // éœ“è™¹å‘å…‰æ•ˆæœ
            ctx.shadowBlur = 15;
            ctx.shadowColor = t.active ? '#e94560' : 'transparent';
            ctx.fillRect(x + 10, t.y, laneWidth - 20, t.height);
            ctx.shadowBlur = 0;

            // è¾¹æ¡†
            ctx.strokeStyle = '#e94560';
            ctx.lineWidth = 3;
            ctx.strokeRect(x + 10, t.y, laneWidth - 20, t.height);

            // æ–‡å­—
            ctx.fillStyle = '#fff';
            ctx.font = 'bold 60px "Microsoft YaHei"';
=======
        // ç”»è½¨é“çº¿
        ctx.strokeStyle = 'rgba(255,255,255,0.1)';
        ctx.lineWidth = 2;
        for (let i = 1; i < LANES; i++) {
            ctx.beginPath();
            ctx.moveTo(i * laneWidth, 0);
            ctx.lineTo(i * laneWidth, canvas.height);
            ctx.stroke();
        }

        // ç”»æ–¹å—
        tiles.forEach(t => {
            const x = t.lane * laneWidth;
            
            // ç´é”®ä¸»ä½“ (é»‘è‰²èƒŒæ™¯ï¼Œç™½è‰²è¾¹æ¡†ï¼Œç±»ä¼¼é’¢ç´)
            ctx.fillStyle = t.active ? '#000' : '#333'; // æ¿€æ´»æ˜¯é»‘ï¼Œç‚¹è¿‡å˜ç°
            if (!t.active) ctx.fillStyle = t.color; // å¦‚æœæ˜¯è¢«ç‚¹ä¸­çš„ï¼Œæ˜¾ç¤ºç‰¹æ®Šè‰²

            // ç»˜åˆ¶åœ†è§’çŸ©å½¢
            ctx.fillRect(x + 2, t.y, laneWidth - 4, t.height);
            
            // è¾¹æ¡†
            ctx.strokeStyle = '#00d2ff';
            ctx.lineWidth = 2;
            ctx.strokeRect(x + 2, t.y, laneWidth - 4, t.height);

            // æ–‡å­—
            ctx.fillStyle = '#fff';
            ctx.font = 'bold 40px "Microsoft YaHei"';
>>>>>>> Stashed changes
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(t.char, x + laneWidth/2, t.y + t.height/2);
        });
    }

    function gameLoop() {
        if (isPlaying) {
            update();
            draw();
            requestAnimationFrame(gameLoop);
        }
    }

<<<<<<< Updated upstream
    // === 3. åˆ¤å®šé€»è¾‘ (å®½æ¾ç‰ˆ) ===
=======
    // === 3. è¾“å…¥åˆ¤å®š (æ ¸å¿ƒçˆ½ç‚¹) ===
>>>>>>> Stashed changes
    function handleInput(x, y) {
        if (isGameOver) return;

        const lane = Math.floor(x / laneWidth);
        
<<<<<<< Updated upstream
        // ã€æ ¸å¿ƒä¿®æ”¹ã€‘åˆ¤å®šè§„åˆ™ï¼š
        // åªè¦åœ¨å½“å‰è½¨é“ï¼Œä¸”æ–¹å—è¿˜æ²¡æœ‰å®Œå…¨æ‰å‡ºåˆ¤å®šçº¿ï¼ˆy < judgmentLineY + å®¹é”™ï¼‰ï¼Œå°±ç®— Perfectã€‚
        // ä¸å­˜åœ¨â€œç‚¹æ—©äº†â€çš„æƒ…å†µã€‚
        const target = tiles.find(t => 
            t.active && 
            t.lane === lane && 
            t.y + t.height > 0 && // å·²ç»è¿›å…¥å±å¹•
            t.y < judgmentLineY + 50 // è¿˜æ²¡æ‰ä¸‹å» (å…è®¸ç¨å¾®è¿‡çº¿ä¸€ç‚¹ç‚¹)
        );

        if (target) {
            // å‘½ä¸­ï¼
            triggerFeedback('perfect');
            score += 100;
            target.color = '#ffd700'; // å˜é‡‘
            target.active = false;
            document.getElementById('score-display').innerText = `å¾—åˆ†: ${score}`;
        } else {
            // ç‚¹ç©ºäº†ï¼Œæ— æƒ©ç½š
=======
        // å¯»æ‰¾è¯¥è½¨é“ä¸Šæœ€æ¥è¿‘åˆ¤å®šçº¿çš„æ–¹å—
        // å¿…é¡»æ˜¯ active çš„
        const target = tiles.find(t => 
            t.active && 
            t.lane === lane && 
            t.y + t.height >= judgmentLineY - 100 && // è¿›å…¥åˆ¤å®šåŒº
            t.y <= judgmentLineY + 100 // è¿˜æ²¡å®Œå…¨æ‰ä¸‹å»
        );

        if (target) {
            // è®¡ç®—è·ç¦» (æ–¹å—ä¸­å¿ƒ vs åˆ¤å®šçº¿)
            const tileCenterY = target.y + target.height / 2;
            const dist = Math.abs(tileCenterY - judgmentLineY);
            
            // åˆ¤å®šè§„åˆ™ (åƒç´ çº§)
            if (dist <= 30) {
                // Perfect
                triggerFeedback('perfect');
                score += 100;
                target.color = '#ffeb3b'; // é‡‘è‰²
            } else if (dist <= 80) {
                // Good
                triggerFeedback('good');
                score += 50;
                target.color = '#00e676'; // ç»¿è‰²
            } else {
                // Miss (ç‚¹å¤ªæ—©æˆ–å¤ªæ™šï¼Œä½†åœ¨èŒƒå›´å†…)
                triggerFeedback('miss');
                combo = 0;
                score -= 20;
                target.color = '#ff1744'; // çº¢è‰²
            }
            
            target.active = false; // æ ‡è®°ä¸ºå·²å¤„ç†
            speakKana(target.char); // æœ—è¯»
            combo++;
            updateScore();
        } else {
            // ç©ºç‚¹ (ç‚¹åˆ°äº†è½¨é“ä½†æ²¡æœ‰æ–¹å—) -> è§†ä¸º Miss å—ï¼Ÿé€šå¸¸éŸ³æ¸¸ä¸æ‰£åˆ†ï¼Œä½†è¿™é‡Œä¸ºäº†ä¸¥è°¨å¯ä»¥ä¸å¤„ç†
>>>>>>> Stashed changes
        }
    }

    function handleMiss() {
        triggerFeedback('miss');
<<<<<<< Updated upstream
        // éœ‡åŠ¨ + çº¢å±
        if (navigator.vibrate) navigator.vibrate(200);
        const overlay = document.getElementById('damage-overlay');
        overlay.style.opacity = 0.5;
        setTimeout(() => overlay.style.opacity = 0, 150);
=======
        combo = 0;
        updateScore();
        
        // éœ‡åŠ¨ + çº¢å±
        if (navigator.vibrate) navigator.vibrate(200);
        const overlay = document.getElementById('damage-overlay');
        overlay.style.opacity = 0.3;
        setTimeout(() => overlay.style.opacity = 0, 100);

        // æ£€æŸ¥å¤±è´¥æ¡ä»¶ (æ¯”å¦‚åˆ†æ•° < -500 æˆ–è€… è¿ç»­Miss 10æ¬¡ï¼Œè¿™é‡Œç®€åŒ–ä¸ºä¸€ç›´ç©)
>>>>>>> Stashed changes
    }

    function triggerFeedback(type) {
        playSound(type);
        
<<<<<<< Updated upstream
        const el = document.createElement('div');
        el.className = `hit-feedback ${type}`;
        el.innerText = type === 'perfect' ? 'PERFECT!' : 'MISS';
        document.getElementById('feedback-container').appendChild(el);
        setTimeout(() => el.remove(), 400);
    }

    // äº¤äº’ç›‘å¬
    canvas.addEventListener('mousedown', e => handleInput(e.clientX, e.clientY));
=======
        // åˆ›å»ºæµ®åŠ¨æ–‡å­—
        const el = document.createElement('div');
        el.className = `hit-feedback ${type}`;
        el.innerText = type.toUpperCase();
        document.getElementById('feedback-container').appendChild(el);
        
        // åŠ¨ç”»ç»“æŸåç§»é™¤
        setTimeout(() => el.remove(), 500);
    }

    function updateScore() {
        document.getElementById('score-display').innerText = `SCORE: ${score}`;
        document.getElementById('combo-display').innerText = `COMBO: ${combo}`;
    }

    // === äº‹ä»¶ç›‘å¬ ===
    // é¼ æ ‡
    canvas.addEventListener('mousedown', e => {
        handleInput(e.clientX, e.clientY);
    });

    // è§¦æ‘¸ (æ”¯æŒå¤šç‚¹è§¦æ§)
>>>>>>> Stashed changes
    canvas.addEventListener('touchstart', e => {
        e.preventDefault();
        for (let i = 0; i < e.changedTouches.length; i++) {
            const t = e.changedTouches[i];
            handleInput(t.clientX, t.clientY);
        }
    }, {passive: false});

</script>
</body>
</html>
