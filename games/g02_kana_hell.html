<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—¥è¯­äº”åéŸ³Â·åœ°ç‹±ç‰¹è®­è¥</title>
    <style>
        :root {
            --primary: #FF6B6B;
            --secondary: #4ECDC4;
            --dark: #2C3E50;
            --light: #F7F9FC;
        }

        body {
            font-family: "Hiragino Sans", "Meiryo", sans-serif;
            background-color: var(--light);
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            color: var(--dark);
        }

        /* é¡¶éƒ¨å¯¼èˆª */
        header {
            background: var(--dark);
            color: white;
            width: 100%;
            padding: 15px 0;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        h1 { margin: 0; font-size: 1.5rem; }
        .subtitle { font-size: 0.8rem; opacity: 0.8; margin-top: 5px; }

        /* æ¨¡å¼é€‰æ‹©æŒ‰é’® */
        .menu {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            flex-wrap: wrap;
            justify-content: center;
        }

        .mode-btn {
            background: white;
            border: 2px solid var(--dark);
            padding: 10px 20px;
            border-radius: 30px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s;
        }

        .mode-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        /* æ¸¸æˆä¸»å®¹å™¨ */
        #game-area {
            width: 90%;
            max-width: 600px;
            background: white;
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.08);
            text-align: center;
            min-height: 400px;
            position: relative;
        }

        /* === æ¨¡å¼1ï¼šé™æ—¶é—¯å…³ === */
        .timer-bar {
            width: 100%;
            height: 8px;
            background: #eee;
            border-radius: 4px;
            margin-bottom: 20px;
            overflow: hidden;
        }
        .timer-fill {
            height: 100%;
            background: var(--primary);
            width: 100%;
            transition: width 1s linear;
        }

        .big-kana {
            font-size: 6rem;
            font-weight: 800;
            margin: 20px 0;
            height: 120px;
        }

        .quiz-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .quiz-btn {
            padding: 15px;
            font-size: 1.5rem;
            border: 2px solid #ddd;
            background: #fff;
            border-radius: 12px;
            cursor: pointer;
        }

        .quiz-btn:active { transform: scale(0.95); }
        .quiz-btn.correct { background: #d4edda; border-color: #28a745; color: #155724; }
        .quiz-btn.wrong { background: #f8d7da; border-color: #dc3545; color: #721c24; animation: shake 0.4s; }

        /* === æ¨¡å¼2ï¼šé…å¯¹è¿è¿çœ‹ === */
        .grid-match {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }
        .card {
            aspect-ratio: 1;
            background: var(--secondary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            border-radius: 10px;
            cursor: pointer;
            transition: transform 0.2s;
            user-select: none;
        }
        .card.selected { background: var(--dark); transform: scale(0.9); box-shadow: inset 0 0 10px rgba(0,0,0,0.5); }
        .card.matched { visibility: hidden; pointer-events: none; } /* æ¶ˆé™¤ */

        /* === æ¨¡å¼3ï¼šä¸€å£æ°”æŒ‘æˆ˜ === */
        .flow-text {
            font-size: 2.5rem;
            line-height: 1.6;
            text-align: left;
            letter-spacing: 5px;
            font-weight: bold;
            word-break: break-all;
        }
        .flow-controls { margin-top: 30px; }

        /* é€šç”¨ç±» */
        .hidden { display: none !important; }
        .stats { font-size: 1.2rem; margin-bottom: 10px; color: #666; display: flex; justify-content: space-between;}
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .game-over-modal {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255,255,255,0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 20px;
            z-index: 10;
        }
        .restart-btn {
            background: var(--dark);
            color: white;
            border: none;
            padding: 10px 30px;
            font-size: 1.2rem;
            border-radius: 25px;
            cursor: pointer;
            margin-top: 20px;
        }

    </style>
</head>
<body>

<header>
    <h1>â›©ï¸ äº”åéŸ³Â·åœ°ç‹±ç‰¹è®­</h1>
    <div class="subtitle">éš¾åº¦å‡çº§ | æ˜“æ··æ·†è¾¨æ | æé€Ÿé…å¯¹</div>
</header>

<div class="menu">
    <button class="mode-btn active" onclick="switchMode('quiz')">ğŸ”¥ é™æ—¶é—¯å…³</button>
    <button class="mode-btn" onclick="switchMode('match')">ğŸ§© è®°å¿†é…å¯¹</button>
    <button class="mode-btn" onclick="switchMode('flow')">âš¡ ä¸€å£æ°”æŒ‘æˆ˜</button>
</div>

<div id="game-area">
    <div id="mode-quiz">
        <div class="stats">
            <span>å¾—åˆ†: <b id="score">0</b></span>
            <span>å‰©ä½™: <b id="time-left">60</b>s</span>
        </div>
        <div class="timer-bar"><div class="timer-fill" id="timer-fill"></div></div>
        
        <div class="big-kana" id="question-kana">ã‚</div>
        <div class="quiz-options" id="quiz-options"></div>
    </div>

    <div id="mode-match" class="hidden">
        <div class="stats">
            <span>å‰©ä½™å¡ç‰‡: <b id="cards-left">16</b></span>
        </div>
        <p style="font-size:0.9rem; color:#888;">ç‚¹å‡»ä¸€ä¸ªå‡åï¼Œå†ç‚¹å‡»å¯¹åº”çš„ç½—é©¬éŸ³æ¶ˆé™¤å®ƒ</p>
        <div class="grid-match" id="match-grid"></div>
    </div>

    <div id="mode-flow" class="hidden">
        <p style="color:#666;">è¯·å­¦ç”Ÿåœ¨ä¸€å£æ°”å†…è¯»å®Œä»¥ä¸‹ä¹±åºå‡åï¼š</p>
        <div class="flow-text" id="flow-content"></div>
        <div class="flow-controls">
            <button class="mode-btn" onclick="generateFlow(10)">ç”Ÿæˆ10ä¸ª</button>
            <button class="mode-btn" onclick="generateFlow(20)">ç”Ÿæˆ20ä¸ª</button>
            <button class="mode-btn" onclick="generateFlow(50)">åœ°ç‹±50è¿</button>
        </div>
    </div>

    <div id="game-over" class="game-over-modal hidden">
        <h2 id="end-title">æ—¶é—´åˆ°ï¼</h2>
        <p style="font-size: 1.5rem;">æœ€ç»ˆå¾—åˆ†: <b id="end-score" style="color:var(--primary)">0</b></p>
        <button class="restart-btn" onclick="restartCurrentGame()">å†æ¥ä¸€å±€</button>
    </div>
</div>

<script>
    // === æ•°æ®å‡†å¤‡ ===
    // åŒ…å«æ˜“æ··æ·†å¯¹çš„æ•°æ®ç»“æ„
    const kanaDB = [
        { k: 'ã‚', r: 'a',  sim: ['ãŠ', 'ã‚', 'ã¬'] },
        { k: 'ã„', r: 'i',  sim: ['ã‚Š', 'ã“'] },
        { k: 'ã†', r: 'u',  sim: ['ã¤', 'ãƒ©'] },
        { k: 'ãˆ', r: 'e',  sim: ['ã‚“', 'å…ƒ'] },
        { k: 'ãŠ', r: 'o',  sim: ['ã‚', 'ã‚€'] },
        { k: 'ã‹', r: 'ka', sim: ['ã‚', 'ã‚„'] },
        { k: 'ã', r: 'ki', sim: ['ã•', 'ã¡'] },
        { k: 'ã', r: 'ku', sim: ['ã¸', 'ã¦'] },
        { k: 'ã‘', r: 'ke', sim: ['ã¯', 'ã«'] },
        { k: 'ã“', r: 'ko', sim: ['ã„', 'ã«'] },
        { k: 'ã•', r: 'sa', sim: ['ã', 'ã¡'] },
        { k: 'ã—', r: 'shi',sim: ['ã¤', 'ã‚‚'] },
        { k: 'ã™', r: 'su', sim: ['ã‚€', 'ãŠ'] },
        { k: 'ã›', r: 'se', sim: ['ã‚µ', 'ä¸–'] },
        { k: 'ã', r: 'so', sim: ['ã‚', 'ã‚‹'] },
        { k: 'ãŸ', r: 'ta', sim: ['ã«', 'ãª'] },
        { k: 'ã¡', r: 'chi',sim: ['ã•', 'ã‚‰'] },
        { k: 'ã¤', r: 'tsu',sim: ['ã—', 'ã†'] },
        { k: 'ã¦', r: 'te', sim: ['ã¨', 'ã'] },
        { k: 'ã¨', r: 'to', sim: ['ã¦', 'ã©'] },
        { k: 'ãª', r: 'na', sim: ['ãŸ', 'ã¯'] },
        { k: 'ã«', r: 'ni', sim: ['ãŸ', 'ã“'] },
        { k: 'ã¬', r: 'nu', sim: ['ã‚', 'ã‚'] },
        { k: 'ã­', r: 'ne', sim: ['ã‚Œ', 'ã‚'] },
        { k: 'ã®', r: 'no', sim: ['ã‚', 'ã¬'] },
        { k: 'ã¯', r: 'ha', sim: ['ã»', 'ã‘'] },
        { k: 'ã²', r: 'hi', sim: ['ã³', 'ã¦'] },
        { k: 'ãµ', r: 'fu', sim: ['ã¶', 'ã·'] },
        { k: 'ã¸', r: 'he', sim: ['ã'] },
        { k: 'ã»', r: 'ho', sim: ['ã¯', 'ã¾'] },
        { k: 'ã¾', r: 'ma', sim: ['ã»', 'ã‚‚'] },
        { k: 'ã¿', r: 'mi', sim: ['H', 'n'] },
        { k: 'ã‚€', r: 'mu', sim: ['ã™', 'ãŠ'] },
        { k: 'ã‚', r: 'me', sim: ['ã¬', 'ã‚'] },
        { k: 'ã‚‚', r: 'mo', sim: ['ã—', 'ã¾'] },
        { k: 'ã‚„', r: 'ya', sim: ['ã‹', 'ã‚»'] },
        { k: 'ã‚†', r: 'yu', sim: ['ã‚'] },
        { k: 'ã‚ˆ', r: 'yo', sim: ['ã¾'] },
        { k: 'ã‚‰', r: 'ra', sim: ['ã¡', '5'] },
        { k: 'ã‚Š', r: 'ri', sim: ['ã„'] },
        { k: 'ã‚‹', r: 'ru', sim: ['ã‚', 'ã'] },
        { k: 'ã‚Œ', r: 're', sim: ['ã­', 'ã‚'] },
        { k: 'ã‚', r: 'ro', sim: ['ã‚‹', 'ã'] },
        { k: 'ã‚', r: 'wa', sim: ['ã‚Œ', 'ã­'] },
        { k: 'ã‚’', r: 'wo', sim: ['ã¡', 'ã•'] },
        { k: 'ã‚“', r: 'n',  sim: ['ãˆ', 'ã‚½'] }
    ];

    let currentMode = 'quiz';
    let score = 0;
    let timer = null;
    let timeLeft = 60;
    let isPlaying = false;
    
    // è¯­éŸ³åŠŸèƒ½
    function speak(text) {
        if('speechSynthesis' in window) {
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'ja-JP'; 
            window.speechSynthesis.speak(utterance);
        }
    }

    // === åˆ‡æ¢æ¨¡å¼ ===
    function switchMode(mode) {
        currentMode = mode;
        // UIåˆ‡æ¢
        document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');
        
        document.getElementById('mode-quiz').classList.add('hidden');
        document.getElementById('mode-match').classList.add('hidden');
        document.getElementById('mode-flow').classList.add('hidden');
        document.getElementById(`mode-${mode}`).classList.remove('hidden');
        document.getElementById('game-over').classList.add('hidden');

        clearInterval(timer);
        if(mode === 'quiz') startQuizGame();
        if(mode === 'match') startMatchGame();
        if(mode === 'flow') generateFlow(10);
    }

    // ===========================
    // æ¨¡å¼1ï¼šé™æ—¶é—¯å…³é€»è¾‘
    // ===========================
    function startQuizGame() {
        score = 0;
        timeLeft = 60;
        isPlaying = true;
        updateStats();
        nextQuiz();
        
        // å€’è®¡æ—¶
        if(timer) clearInterval(timer);
        timer = setInterval(() => {
            timeLeft--;
            updateStats();
            document.getElementById('timer-fill').style.width = (timeLeft/60*100) + "%";
            if(timeLeft <= 0) endGame();
        }, 1000);
    }

    function updateStats() {
        document.getElementById('score').innerText = score;
        document.getElementById('time-left').innerText = timeLeft;
    }

    function nextQuiz() {
        if(!isPlaying) return;
        const target = kanaDB[Math.floor(Math.random() * kanaDB.length)];
        document.getElementById('question-kana').innerText = target.k;
        
        // éš¾ç‚¹é€»è¾‘ï¼šä¼˜å…ˆæ··æ·†é¡¹
        let options = [];
        options.push(target.r); // æ­£ç¡®ç­”æ¡ˆ
        
        // å¯»æ‰¾ä¸“é—¨çš„æ··æ·†é¡¹ç½—é©¬éŸ³
        // è¿™é‡Œç®€åŒ–é€»è¾‘ï¼šå¦‚æœæ··æ·†é¡¹æ˜¯å‡åï¼Œæˆ‘ä»¬è¦æ‰¾å®ƒçš„ç½—é©¬éŸ³ã€‚
        // ä¸ºäº†ä»£ç ç®€å•ï¼Œè¿™é‡Œæˆ‘ä»¬ä»åº“é‡Œæ‰¾å‡ ä¸ªéæ­£ç¡®çš„éšæœºç½—é©¬éŸ³ï¼Œ
        // ä½†å¦‚æœæ•°æ®åº“å®Œå–„ï¼Œåº”è¯¥é€šè¿‡ sim å­—æ®µæ‰¾åˆ°å¯¹åº”çš„ç½—é©¬éŸ³ã€‚
        // ç°åœ¨çš„é€»è¾‘ï¼šä»æ‰€æœ‰æ•°æ®ä¸­ï¼Œæ’é™¤å½“å‰ç­”æ¡ˆï¼Œéšæœºé€‰3ä¸ªã€‚
        // è¿›é˜¶é€»è¾‘ï¼ˆä½ çš„è¦æ±‚ï¼‰ï¼šå°½å¯èƒ½é€‰é•¿å¾—åƒçš„å‡åå¯¹åº”çš„ç½—é©¬éŸ³ã€‚
        
        let pool = kanaDB.filter(i => i.r !== target.r);
        
        // å°è¯•ä» target.sim é‡Œæ‰¾å¯¹åº”çš„ç½—é©¬éŸ³
        if(target.sim) {
            target.sim.forEach(simChar => {
                const found = kanaDB.find(db => db.k === simChar);
                if(found && options.length < 4) options.push(found.r);
            });
        }
        
        // è¡¥è¶³4ä¸ªé€‰é¡¹
        while(options.length < 4) {
            const rand = pool[Math.floor(Math.random() * pool.length)];
            if(!options.includes(rand.r)) options.push(rand.r);
        }
        
        options = options.sort(() => Math.random() - 0.5);

        const container = document.getElementById('quiz-options');
        container.innerHTML = '';
        options.forEach(opt => {
            const btn = document.createElement('button');
            btn.className = 'quiz-btn';
            btn.innerText = opt;
            btn.onclick = () => checkQuiz(btn, opt, target);
            container.appendChild(btn);
        });
    }

    function checkQuiz(btn, selectedRomaji, targetObj) {
        if(!isPlaying) return;
        
        if(selectedRomaji === targetObj.r) {
            btn.classList.add('correct');
            score += 10;
            speak(targetObj.k); // è¯»å‡ºå£°éŸ³
            setTimeout(nextQuiz, 500);
        } else {
            btn.classList.add('wrong');
            navigator.vibrate(200); // æ‰‹æœºéœ‡åŠ¨
            score = Math.max(0, score - 5); // æ‰£åˆ†
            updateStats();
        }
        updateStats();
    }

    function endGame() {
        isPlaying = false;
        clearInterval(timer);
        document.getElementById('game-over').classList.remove('hidden');
        document.getElementById('end-score').innerText = score;
    }

    // ===========================
    // æ¨¡å¼2ï¼šé…å¯¹è¿è¿çœ‹é€»è¾‘
    // ===========================
    let matchSelected = null;
    let cardsLeft = 0;

    function startMatchGame() {
        const grid = document.getElementById('match-grid');
        grid.innerHTML = '';
        matchSelected = null;
        
        // é€‰8å¯¹æ•°æ® (16å¼ å¡)
        let set = kanaDB.sort(() => Math.random() - 0.5).slice(0, 8);
        let cards = [];
        set.forEach(item => {
            cards.push({ type: 'kana', val: item.k, id: item.r });
            cards.push({ type: 'romaji', val: item.r, id: item.r });
        });
        cards.sort(() => Math.random() - 0.5);
        
        cardsLeft = cards.length;
        document.getElementById('cards-left').innerText = cardsLeft;

        cards.forEach(card => {
            const el = document.createElement('div');
            el.className = 'card';
            el.innerText = card.val;
            el.dataset.id = card.id; // åŒ¹é…çš„å…³é”®
            el.onclick = () => handleCardClick(el);
            grid.appendChild(el);
        });
    }

    function handleCardClick(el) {
        if(el.classList.contains('matched') || el === matchSelected) return;

        el.classList.add('selected');

        if(!matchSelected) {
            // ç¬¬ä¸€å¼ 
            matchSelected = el;
        } else {
            // ç¬¬äºŒå¼ ï¼Œæ£€æŸ¥åŒ¹é…
            if(el.dataset.id === matchSelected.dataset.id) {
                // åŒ¹é…æˆåŠŸ
                setTimeout(() => {
                    el.classList.add('matched');
                    matchSelected.classList.add('matched');
                    matchSelected = null;
                    cardsLeft -= 2;
                    document.getElementById('cards-left').innerText = cardsLeft;
                    speak(el.dataset.id === el.innerText ? "" : el.innerText); // å°è¯•è¯»å‡ºå‡å
                    if(cardsLeft === 0) {
                        alert("ğŸ‰ å®Œæˆï¼å¤ªæ£’äº†ï¼");
                        startMatchGame();
                    }
                }, 200);
            } else {
                // åŒ¹é…å¤±è´¥
                setTimeout(() => {
                    el.classList.remove('selected');
                    matchSelected.classList.remove('selected');
                    matchSelected = null;
                }, 500);
            }
        }
    }

    // ===========================
    // æ¨¡å¼3ï¼šä¸€å£æ°”æŒ‘æˆ˜é€»è¾‘
    // ===========================
    function generateFlow(count) {
        const container = document.getElementById('flow-content');
        let text = "";
        for(let i=0; i<count; i++) {
            text += kanaDB[Math.floor(Math.random() * kanaDB.length)].k;
        }
        container.innerText = text;
    }

    function restartCurrentGame() {
        document.getElementById('game-over').classList.add('hidden');
        if(currentMode === 'quiz') startQuizGame();
        // å…¶ä»–æ¨¡å¼ä¸€èˆ¬ä¸éœ€è¦è¿™ä¸ªå¼¹çª—ï¼Œä½†ä»¥é˜²ä¸‡ä¸€
    }

    // å¯åŠ¨é»˜è®¤
    startQuizGame();

</script>
</body>
</html>