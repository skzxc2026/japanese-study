<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å‡åæ¶ˆæ¶ˆä¹ V8.0 (æ‹–æ‹½ç‰ˆ)</title>
    <style>
        :root {
            --bg-color: #f8f9fa;
            --text-main: #2d3436;
            --font-cn: "Microsoft YaHei", "PingFang SC", sans-serif;
            --font-jp: "M PLUS Rounded 1c", sans-serif;
            
            /* å“ç‰Œè‰² */
            --c-green: #00b894;
            --c-blue: #0984e3;
            --c-purple: #6c5ce7;
            --c-red: #d63031;
        }

        body {
            font-family: var(--font-cn);
            background-color: var(--bg-color);
            margin: 0; height: 100vh;
            overflow: hidden; user-select: none;
            color: var(--text-main);
        }

        /* ================= å¸ƒå±€å®¹å™¨ ================= */
        .app-container {
            display: flex;
            width: 100%; height: 100%;
            position: relative;
            transition: all 0.5s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        /* å·¦ä¾§ï¼šä¸»èœå•é¢æ¿ */
        .left-panel {
            flex: 1;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            background: white;
            z-index: 10;
            box-shadow: 5px 0 30px rgba(0,0,0,0.05);
            transition: all 0.5s ease;
            padding: 20px;
        }
        
        .app-container.mode-active .left-panel {
            flex: 0 0 35%; 
            align-items: flex-end; 
            padding-right: 40px;
            background: #f1f2f6; 
        }

        /* å³ä¾§ï¼šå­èœå•é¢æ¿ */
        .right-panel {
            flex: 0; width: 0; opacity: 0;
            background: white;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            overflow: hidden;
            transition: all 0.5s ease;
            position: relative;
        }

        .app-container.mode-active .right-panel {
            flex: 1; width: auto; opacity: 1;
        }

        /* ================= å·¦ä¾§å†…å®¹è®¾è®¡ ================= */
        .title-area {
            text-align: center; margin-bottom: 40px;
            transition: transform 0.4s;
        }
        .app-title {
            font-size: 48px; font-weight: 900; color: #333;
            letter-spacing: 2px; margin: 0;
        }
        .app-subtitle { color: #b2bec3; font-size: 16px; margin-top: 5px; font-weight: bold; }

        .menu-list {
            display: flex; flex-direction: column; gap: 20px;
            width: 100%; max-width: 320px;
        }

        .mode-card {
            background: white; border-radius: 20px; padding: 20px 25px;
            display: flex; align-items: center; justify-content: space-between;
            cursor: pointer; transition: all 0.3s;
            border: 2px solid transparent;
            box-shadow: 0 10px 20px rgba(0,0,0,0.05);
            position: relative; overflow: hidden;
        }
        
        .icon-circle {
            width: 50px; height: 50px; border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            font-size: 24px; color: white; margin-right: 15px; flex-shrink: 0;
        }

        .mode-info { flex: 1; }
        .m-title { font-size: 20px; font-weight: bold; color: #2d3436; }
        .m-desc { font-size: 12px; color: #aaa; margin-top: 2px; }
        .arrow { color: #ddd; font-weight: bold; transition: 0.3s; }

        .mc-green .icon-circle { background: linear-gradient(135deg, #55efc4, #00b894); }
        .mc-blue .icon-circle  { background: linear-gradient(135deg, #74b9ff, #0984e3); }
        .mc-purple .icon-circle{ background: linear-gradient(135deg, #a29bfe, #6c5ce7); }
        .mc-red .icon-circle   { background: linear-gradient(135deg, #ff7675, #d63031); }

        .mode-card:hover { transform: translateY(-3px); box-shadow: 0 15px 30px rgba(0,0,0,0.1); }
        .mode-card:hover .arrow { color: #333; transform: translateX(5px); }

        .app-container.mode-active .mode-card {
            padding: 15px; background: white; opacity: 0.6; transform: scale(0.95);
        }
        .app-container.mode-active .mode-card.active {
            opacity: 1; border-color: var(--active-color);
            transform: scale(1.05) translateX(10px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1); z-index: 2;
        }

        /* ================= å³ä¾§å†…å®¹è®¾è®¡ ================= */
        .sub-content {
            width: 90%; max-width: 450px; padding: 20px;
            animation: slideIn 0.4s 0.1s backwards;
        }
        
        .sub-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .sub-title { font-size: 28px; font-weight: 800; color: #333; }
        
        .chapter-grid { display: grid; gap: 15px; }
        
        .chapter-item {
            background: white; border: 1px solid #eee;
            border-radius: 16px; padding: 20px;
            display: flex; align-items: center; justify-content: space-between;
            cursor: pointer; transition: 0.2s;
        }
        .chapter-item:hover {
            border-color: var(--active-color); background: #fdfdfd;
            transform: translateX(5px); box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }
        
        .cp-left h3 { margin: 0; font-size: 18px; color: #333; }
        .cp-left p { margin: 5px 0 0; font-size: 13px; color: #999; }
        .cp-tag {
            font-size: 12px; font-weight: bold; padding: 5px 12px;
            border-radius: 20px; background: #f0f0f0; color: #666;
        }

        .timer-switch {
            display: flex; align-items: center; gap: 10px;
            background: #fff; padding: 8px 16px; border-radius: 30px;
            border: 1px solid #eee; font-size: 14px; font-weight: bold; color: #555;
        }
        .switch-ui {
            width: 40px; height: 22px; background: #ccc; border-radius: 22px;
            position: relative; transition: 0.3s; cursor: pointer;
        }
        .switch-ui::after {
            content:''; position: absolute; top: 2px; left: 2px; width: 18px; height: 18px;
            background: white; border-radius: 50%; transition: 0.3s;
        }
        input:checked + .switch-ui { background: #ff6b6b; }
        input:checked + .switch-ui::after { transform: translateX(18px); }

        .close-sub-btn { display: none; font-size: 24px; color: #999; cursor: pointer; }

        /* ================= 3. æ¸¸æˆç•Œé¢ ================= */
        .game-screen {
            display: none; flex-direction: column; height: 100%;
            position: fixed; top: 0; left: 0; width: 100%; z-index: 200;
            background: #fdfbf7;
        }
        
        .header {
            padding: 15px 20px; background: white;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); z-index: 10;
        }
        .top-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        
        /* é¡¶éƒ¨æŒ‰é’®ç»„ */
        .btn-group { display: flex; gap: 10px; align-items: center; }
        .icon-btn {
            border: none; background: #eee; width: 40px; height: 40px; border-radius: 50%;
            font-size: 20px; cursor: pointer; display: flex; justify-content: center; align-items: center;
            transition: 0.2s;
        }
        .icon-btn:active { transform: scale(0.9); background: #ddd; }

        .lvl-info { font-size: 20px; font-weight: 900; color: #2c3e50; }
        .timer-display { font-size: 24px; font-weight: bold; color: #e74c3c; font-family: monospace; }
        
        .progress-track { width: 100%; height: 8px; background: #f0f0f0; border-radius: 4px; overflow: hidden; }
        .progress-fill { height: 100%; background: #2ecc71; width: 0%; transition: width 0.3s; }

        .board {
            flex: 1; padding: 20px;
            display: flex; flex-wrap: wrap; justify-content: center; align-content: center;
            gap: 15px; overflow-y: auto;
            /* é˜²æ­¢è§¦æ‘¸æ—¶æ•´ä¸ªé¡µé¢æ»šåŠ¨ */
            touch-action: none; 
        }

        /* å¡ç‰‡æ ·å¼å‡çº§ï¼šæ”¯æŒæ‹–æ‹½ */
        .card {
            width: 75px; height: 75px; border-radius: 18px;
            display: flex; justify-content: center; align-items: center;
            font-size: 26px; font-weight: bold; cursor: grab; 
            position: relative; /* å¿…é¡»ç›¸å¯¹å®šä½ä»¥ä¾¿ä½ç§» */
            background: white; color: #555;
            box-shadow: 0 6px 0 rgba(0,0,0,0.1); 
            opacity: 0; transform: translateY(20px);
            touch-action: none; /* å…³é”®ï¼šç¦æ­¢æµè§ˆå™¨é»˜è®¤è§¦æ‘¸è¡Œä¸º */
            z-index: 1;
            transition: transform 0.2s, opacity 0.2s; /* é»˜è®¤çŠ¶æ€ä¸‹çš„è¿‡æ¸¡ */
        }
        
        .card.show { opacity: 1; transform: translateY(0); }
        
        /* æ‹–æ‹½ä¸­çŠ¶æ€ */
        .card.dragging {
            z-index: 1000; /* æµ®åœ¨æœ€ä¸Šå±‚ */
            transform: scale(1.2); /* æ”¾å¤§ */
            opacity: 0.9;
            box-shadow: 0 15px 30px rgba(0,0,0,0.2);
            cursor: grabbing;
            transition: none; /* æ‹–æ‹½æ—¶å–æ¶ˆè¿‡æ¸¡ï¼Œä¿è¯è·Ÿæ‰‹ */
        }

        .card.matched { transform: scale(0); opacity: 0; transition: 0.4s; pointer-events: none; }
        
        /* é”™è¯¯éœ‡åŠ¨ */
        .card.wrong { animation: shake 0.4s; background: #ff7675 !important; color: white !important; }

        .card.color-a { background: var(--c1-bg); color: var(--c1-txt); box-shadow: 0 6px 0 var(--c1-shadow); }
        .card.color-b { background: var(--c2-bg); color: var(--c2-txt); box-shadow: 0 6px 0 var(--c2-shadow); }
        .card.romaji { font-family: "Varela Round", sans-serif; font-size: 20px; }
        .card.kana { font-family: var(--font-jp); }

        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 300;
            display: none; justify-content: center; align-items: center;
            opacity: 0; transition: opacity 0.3s;
        }
        .modal.open { display: flex; opacity: 1; }
        .modal-box {
            background: white; width: 85%; max-width: 320px;
            border-radius: 24px; padding: 30px; text-align: center;
            transform: translateY(50px); transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .modal.open .modal-box { transform: translateY(0); }
        
        .modal h2 { font-size: 28px; color: #2d3436; margin: 0 0 10px; }
        .stat-row { display: flex; justify-content: center; gap: 20px; margin: 20px 0; }
        .stat-item { display: flex; flex-direction: column; }
        .stat-val { font-size: 24px; font-weight: 900; color: #00b894; }
        .stat-label { font-size: 12px; color: #b2bec3; }
        
        .btn-primary {
            background: #0984e3; color: white; border: none;
            padding: 12px 30px; border-radius: 50px; font-size: 16px; font-weight: bold;
            cursor: pointer; box-shadow: 0 5px 15px rgba(9, 132, 227, 0.4);
            transition: 0.2s; width: 100%;
        }
        .btn-primary:active { transform: scale(0.95); }

        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        @keyframes slideIn { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }

        /* ç§»åŠ¨ç«¯é€‚é… */
        @media (max-width: 768px) {
            .app-container { flex-direction: column; }
            .left-panel { flex: 1; width: 100%; padding: 20px; }
            .app-container.mode-active .left-panel { flex: 0 0 auto; height: 120px; align-items: center; padding: 10px; flex-direction: row; justify-content: space-between; z-index: 20; }
            .app-container.mode-active .title-area { text-align: left; margin: 0; transform: scale(0.7); transform-origin: left center; }
            .app-container.mode-active .menu-list { display: none; }
            
            .right-panel { width: 100%; }
            .close-sub-btn { display: block; }
            
            .card { width: 60px; height: 60px; font-size: 22px; }
            .board { gap: 10px; padding: 10px; }
        }
    </style>
</head>
<body>

    <div class="app-container" id="appContainer">
        <!-- å·¦ä¾§ï¼šæ¨¡å¼é€‰æ‹© -->
        <div class="left-panel">
            <div class="title-area">
                <h1 class="app-title">äº”åéŸ³</h1>
                <div class="app-subtitle">æ¶ˆæ¶ˆä¹å¤§ä½œæˆ˜</div>
            </div>
            
            <div class="menu-list">
                <div class="mode-card mc-green" onclick="selectMode('seion', this, '#00b894', '#dcfce7')">
                    <div class="icon-circle">æ¸…</div>
                    <div class="mode-info">
                        <div class="m-title">æ¸…éŸ³æŒ‘æˆ˜</div>
                        <div class="m-desc">åŸºç¡€äº”åéŸ³ (ã‚-ã‚“)</div>
                    </div>
                    <div class="arrow">â†’</div>
                </div>
                <div class="mode-card mc-blue" onclick="selectMode('dakuon', this, '#0984e3', '#dbeafe')">
                    <div class="icon-circle">æµŠ</div>
                    <div class="mode-info">
                        <div class="m-title">æµŠéŸ³æŒ‘æˆ˜</div>
                        <div class="m-desc">ç‚¹ç‚¹ä¸åœˆåœˆ (ãŒ-ã½)</div>
                    </div>
                    <div class="arrow">â†’</div>
                </div>
                <div class="mode-card mc-purple" onclick="selectMode('yoon', this, '#6c5ce7', '#f3e8ff')">
                    <div class="icon-circle">æ‹—</div>
                    <div class="mode-info">
                        <div class="m-title">æ‹—éŸ³æŒ‘æˆ˜</div>
                        <div class="m-desc">ç»„åˆå‘éŸ³ (ãã‚ƒ-ã´ã‚‡)</div>
                    </div>
                    <div class="arrow">â†’</div>
                </div>
            </div>
        </div>

        <!-- å³ä¾§ï¼šå…³å¡é€‰æ‹© -->
        <div class="right-panel">
            <div class="sub-content">
                <div class="sub-header">
                    <div class="sub-title">é€‰æ‹©å…³å¡</div>
                    <div class="close-sub-btn" onclick="resetMode()">Ã—</div>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <label class="timer-switch">
                        <input type="checkbox" id="timerMode" style="display:none">
                        <div class="switch-ui"></div>
                        <span>é™æ—¶æ¨¡å¼ (60ç§’)</span>
                    </label>
                </div>

                <div class="chapter-grid" id="chapterList">
                    <!-- JSç”Ÿæˆ -->
                </div>
            </div>
        </div>
    </div>

    <!-- æ¸¸æˆç•Œé¢ -->
    <div class="game-screen" id="gameScreen">
        <div class="header">
            <div class="top-row">
                <div class="btn-group">
                    <button class="icon-btn" onclick="exitGame()">ğŸ”™</button>
                    <div class="lvl-info" id="gameTitle">Level 1</div>
                </div>
                <div class="timer-display" id="gameTimer">00:00</div>
            </div>
            <div class="progress-track">
                <div class="progress-fill" id="progressBar"></div>
            </div>
        </div>
        
        <div class="board" id="gameBoard"></div>
    </div>

    <!-- ç»“ç®—å¼¹çª— -->
    <div class="modal" id="resultModal">
        <div class="modal-box">
            <h2 id="resTitle">ğŸ‰ æŒ‘æˆ˜æˆåŠŸ</h2>
            <div class="stat-row">
                <div class="stat-item">
                    <span class="stat-val" id="resTime">45s</span>
                    <span class="stat-label">è€—æ—¶</span>
                </div>
                <div class="stat-item">
                    <span class="stat-val" id="resScore">100</span>
                    <span class="stat-label">å¾—åˆ†</span>
                </div>
            </div>
            <button class="btn-primary" onclick="closeModal()">è¿”å›èœå•</button>
        </div>
    </div>

    <script>
        // ================= 1. æ•°æ®å®šä¹‰ =================
        const DATA = {
            seion: [
                { id: 'a', kana: 'ã‚', roma: 'a' }, { id: 'i', kana: 'ã„', roma: 'i' }, { id: 'u', kana: 'ã†', roma: 'u' }, { id: 'e', kana: 'ãˆ', roma: 'e' }, { id: 'o', kana: 'ãŠ', roma: 'o' },
                { id: 'ka', kana: 'ã‹', roma: 'ka' }, { id: 'ki', kana: 'ã', roma: 'ki' }, { id: 'ku', kana: 'ã', roma: 'ku' }, { id: 'ke', kana: 'ã‘', roma: 'ke' }, { id: 'ko', kana: 'ã“', roma: 'ko' },
                { id: 'sa', kana: 'ã•', roma: 'sa' }, { id: 'shi', kana: 'ã—', roma: 'shi' }, { id: 'su', kana: 'ã™', roma: 'su' }, { id: 'se', kana: 'ã›', roma: 'se' }, { id: 'so', kana: 'ã', roma: 'so' },
                { id: 'ta', kana: 'ãŸ', roma: 'ta' }, { id: 'chi', kana: 'ã¡', roma: 'chi' }, { id: 'tsu', kana: 'ã¤', roma: 'tsu' }, { id: 'te', kana: 'ã¦', roma: 'te' }, { id: 'to', kana: 'ã¨', roma: 'to' },
                { id: 'na', kana: 'ãª', roma: 'na' }, { id: 'ni', kana: 'ã«', roma: 'ni' }, { id: 'nu', kana: 'ã¬', roma: 'nu' }, { id: 'ne', kana: 'ã­', roma: 'ne' }, { id: 'no', kana: 'ã®', roma: 'no' },
                { id: 'ha', kana: 'ã¯', roma: 'ha' }, { id: 'hi', kana: 'ã²', roma: 'hi' }, { id: 'fu', kana: 'ãµ', roma: 'fu' }, { id: 'he', kana: 'ã¸', roma: 'he' }, { id: 'ho', kana: 'ã»', roma: 'ho' },
                { id: 'ma', kana: 'ã¾', roma: 'ma' }, { id: 'mi', kana: 'ã¿', roma: 'mi' }, { id: 'mu', kana: 'ã‚€', roma: 'mu' }, { id: 'me', kana: 'ã‚', roma: 'me' }, { id: 'mo', kana: 'ã‚‚', roma: 'mo' },
                { id: 'ya', kana: 'ã‚„', roma: 'ya' }, { id: 'yu', kana: 'ã‚†', roma: 'yu' }, { id: 'yo', kana: 'ã‚ˆ', roma: 'yo' },
                { id: 'ra', kana: 'ã‚‰', roma: 'ra' }, { id: 'ri', kana: 'ã‚Š', roma: 'ri' }, { id: 'ru', kana: 'ã‚‹', roma: 'ru' }, { id: 're', kana: 'ã‚Œ', roma: 're' }, { id: 'ro', kana: 'ã‚', roma: 'ro' },
                { id: 'wa', kana: 'ã‚', roma: 'wa' }, { id: 'wo', kana: 'ã‚’', roma: 'wo' }, { id: 'n', kana: 'ã‚“', roma: 'n' }
            ],
            dakuon: [
                { id: 'ga', kana: 'ãŒ', roma: 'ga' }, { id: 'gi', kana: 'ã', roma: 'gi' }, { id: 'gu', kana: 'ã', roma: 'gu' }, { id: 'ge', kana: 'ã’', roma: 'ge' }, { id: 'go', kana: 'ã”', roma: 'go' },
                { id: 'za', kana: 'ã–', roma: 'za' }, { id: 'ji', kana: 'ã˜', roma: 'ji' }, { id: 'zu', kana: 'ãš', roma: 'zu' }, { id: 'ze', kana: 'ãœ', roma: 'ze' }, { id: 'zo', kana: 'ã', roma: 'zo' },
                { id: 'da', kana: 'ã ', roma: 'da' }, { id: 'ji_d', kana: 'ã¢', roma: 'ji' }, { id: 'zu_d', kana: 'ã¥', roma: 'zu' }, { id: 'de', kana: 'ã§', roma: 'de' }, { id: 'do', kana: 'ã©', roma: 'do' },
                { id: 'ba', kana: 'ã°', roma: 'ba' }, { id: 'bi', kana: 'ã³', roma: 'bi' }, { id: 'bu', kana: 'ã¶', roma: 'bu' }, { id: 'be', kana: 'ã¹', roma: 'be' }, { id: 'bo', kana: 'ã¼', roma: 'bo' },
                { id: 'pa', kana: 'ã±', roma: 'pa' }, { id: 'pi', kana: 'ã´', roma: 'pi' }, { id: 'pu', kana: 'ã·', roma: 'pu' }, { id: 'pe', kana: 'ãº', roma: 'pe' }, { id: 'po', kana: 'ã½', roma: 'po' }
            ],
            yoon: [
                { id: 'kya', kana: 'ãã‚ƒ', roma: 'kya' }, { id: 'kyu', kana: 'ãã‚…', roma: 'kyu' }, { id: 'kyo', kana: 'ãã‚‡', roma: 'kyo' },
                { id: 'sha', kana: 'ã—ã‚ƒ', roma: 'sha' }, { id: 'shu', kana: 'ã—ã‚…', roma: 'shu' }, { id: 'sho', kana: 'ã—ã‚‡', roma: 'sho' },
                { id: 'cha', kana: 'ã¡ã‚ƒ', roma: 'cha' }, { id: 'chu', kana: 'ã¡ã‚…', roma: 'chu' }, { id: 'cho', kana: 'ã¡ã‚‡', roma: 'cho' },
                { id: 'nya', kana: 'nya', roma: 'nya' }, { id: 'nyu', kana: 'nyu', roma: 'nyu' }, { id: 'nyo', kana: 'nyo', roma: 'nyo' },
                { id: 'hya', kana: 'hya', roma: 'hya' }, { id: 'hyu', kana: 'hyu', roma: 'hyu' }, { id: 'hyo', kana: 'hyo', roma: 'hyo' },
                { id: 'mya', kana: 'mya', roma: 'mya' }, { id: 'myu', kana: 'myu', roma: 'myu' }, { id: 'myo', kana: 'myo', roma: 'myo' },
                { id: 'rya', kana: 'rya', roma: 'rya' }, { id: 'ryu', kana: 'ryu', roma: 'ryu' }, { id: 'ryo', kana: 'ryo', roma: 'ryo' },
                { id: 'gya', kana: 'gya', roma: 'gya' }, { id: 'gyu', kana: 'gyu', roma: 'gyu' }, { id: 'gyo', kana: 'gyo', roma: 'gyo' },
                { id: 'ja', kana: 'ja', roma: 'ja' }, { id: 'ju', kana: 'ju', roma: 'ju' }, { id: 'jo', kana: 'jo', roma: 'jo' },
                { id: 'bya', kana: 'bya', roma: 'bya' }, { id: 'byu', kana: 'byu', roma: 'byu' }, { id: 'byo', kana: 'byo', roma: 'byo' },
                { id: 'pya', kana: 'pya', roma: 'pya' }, { id: 'pyu', kana: 'pyu', roma: 'pyu' }, { id: 'pyo', kana: 'pyo', roma: 'pyo' }
            ]
        };

        // ================= 2. çŠ¶æ€ç®¡ç† =================
        let currentMode = '';
        let currentLevel = 0;
        let gameTimer = null;
        let startTime = 0;
        let matchedCount = 0;
        let totalPairs = 0;
        let isTimeMode = false;

        // é¢œè‰²é…ç½®
        const THEMES = {
            seion: { main: '#00b894', bg: '#dcfce7', c1: {bg:'#e0f2f1', txt:'#00695c', s:'#b2dfdb'}, c2: {bg:'#e8f5e9', txt:'#2e7d32', s:'#c8e6c9'} },
            dakuon: { main: '#0984e3', bg: '#dbeafe', c1: {bg:'#e3f2fd', txt:'#1565c0', s:'#bbdefb'}, c2: {bg:'#e8eaf6', txt:'#283593', s:'#c5cae9'} },
            yoon: { main: '#6c5ce7', bg: '#f3e8ff', c1: {bg:'#f3e5f5', txt:'#6a1b9a', s:'#e1bee7'}, c2: {bg:'#ede7f6', txt:'#4527a0', s:'#d1c4e9'} }
        };

        // ================= 3. ğŸ”Š å£°éŸ³ç³»ç»Ÿ (AudioContext) =================
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        
        function playTone(freq, type, duration) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = type;
            osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + duration);
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            osc.stop(audioCtx.currentTime + duration);
        }

        function playSound(type) {
            switch(type) {
                case 'click': playTone(400, 'triangle', 0.1); break; // æ‹¿èµ·
                case 'match': playTone(800, 'sine', 0.2); break;     // åŒ¹é…æˆåŠŸ
                case 'wrong': playTone(150, 'sawtooth', 0.3); break; // é”™è¯¯
                case 'win': 
                    setTimeout(() => playTone(500, 'sine', 0.2), 0);
                    setTimeout(() => playTone(600, 'sine', 0.2), 200);
                    setTimeout(() => playTone(800, 'sine', 0.4), 400);
                    break;
            }
        }

        // ================= 4. ç•Œé¢äº¤äº’ =================
        function selectMode(mode, el, color, bgColor) {
            currentMode = mode;
            document.querySelectorAll('.mode-card').forEach(c => c.classList.remove('active'));
            el.classList.add('active');
            
            document.documentElement.style.setProperty('--active-color', color);
            document.getElementById('appContainer').classList.add('mode-active');
            
            renderChapters(mode);
        }

        function resetMode() {
            document.getElementById('appContainer').classList.remove('mode-active');
            setTimeout(() => {
                document.querySelectorAll('.mode-card').forEach(c => c.classList.remove('active'));
            }, 300);
        }

        function renderChapters(mode) {
            const list = document.getElementById('chapterList');
            list.innerHTML = '';
            
            const data = DATA[mode];
            const step = 5; // æ¯å…³5å¯¹
            const totalLevels = Math.ceil(data.length / step);

            for(let i=0; i<totalLevels; i++) {
                const start = i * step;
                const end = Math.min(start + step, data.length);
                const chars = data.slice(start, end).map(d => d.kana).join(' ');
                
                const div = document.createElement('div');
                div.className = 'chapter-item';
                div.innerHTML = `
                    <div class="cp-left">
                        <h3>ç¬¬ ${i+1} å…³</h3>
                        <p>${chars}</p>
                    </div>
                    <div class="cp-tag">å¼€å§‹æŒ‘æˆ˜</div>
                `;
                div.onclick = () => initLevel(i);
                list.appendChild(div);
            }
        }

        // ================= 5. æ¸¸æˆæ ¸å¿ƒé€»è¾‘ (æ‹–æ‹½ç‰ˆ) =================
        function initLevel(levelIdx) {
            currentLevel = levelIdx;
            isTimeMode = document.getElementById('timerMode').checked;
            
            const theme = THEMES[currentMode];
            document.documentElement.style.setProperty('--c1-bg', theme.c1.bg);
            document.documentElement.style.setProperty('--c1-txt', theme.c1.txt);
            document.documentElement.style.setProperty('--c1-shadow', theme.c1.s);
            document.documentElement.style.setProperty('--c2-bg', theme.c2.bg);
            document.documentElement.style.setProperty('--c2-txt', theme.c2.txt);
            document.documentElement.style.setProperty('--c2-shadow', theme.c2.s);

            document.getElementById('gameScreen').style.display = 'flex';
            document.getElementById('gameTitle').textContent = `ç¬¬ ${levelIdx + 1} å…³`;
            
            // å‡†å¤‡æ•°æ®
            const allData = DATA[currentMode];
            const start = levelIdx * 5;
            const end = Math.min(start + 5, allData.length);
            const levelData = allData.slice(start, end);
            
            let cards = [];
            levelData.forEach(item => {
                // ç½—é©¬éŸ³å¡ç‰‡
                cards.push({ id: item.id, val: item.roma, type: 'roma', pairId: item.id });
                // å‡åå¡ç‰‡
                cards.push({ id: item.id, val: item.kana, type: 'kana', pairId: item.id });
            });
            
            // æ´—ç‰Œ
            cards.sort(() => Math.random() - 0.5);
            
            renderBoard(cards);
            startTimer();
        }

        function renderBoard(cards) {
            const board = document.getElementById('gameBoard');
            board.innerHTML = '';
            matchedCount = 0;
            totalPairs = cards.length / 2;
            
            cards.forEach((item, index) => {
                const card = createCard(item);
                board.appendChild(card);
                // ä¾æ¬¡å…¥åœºåŠ¨ç”»
                setTimeout(() => card.classList.add('show'), index * 50);
            });
        }

        function createCard(item) {
            const el = document.createElement('div');
            el.className = `card ${item.type === 'roma' ? 'color-a romaji' : 'color-b kana'}`;
            el.textContent = item.val;
            el.dataset.pairId = item.pairId; // ç”¨äºåˆ¤æ–­åŒ¹é…
            el.dataset.uuid = Math.random().toString(36).substr(2, 9); // å”¯ä¸€æ ‡è¯†ï¼Œé˜²æ­¢è‡ªå·±åŒ¹é…è‡ªå·±

            // ç»‘å®šæ‹–æ‹½äº‹ä»¶
            addDragListeners(el);
            
            return el;
        }

        // âœ‹ æ ¸å¿ƒæ‹–æ‹½é€»è¾‘
        function addDragListeners(card) {
            let startX, startY;
            
            const startDrag = (e) => {
                // å¦‚æœå·²ç»åŒ¹é…æ¶ˆé™¤ï¼Œæˆ–è€…æ­£åœ¨åŠ¨ç”»ä¸­ï¼Œç¦æ­¢æ‹–æ‹½
                if(card.classList.contains('matched')) return;
                
                // æ¿€æ´»éŸ³é¢‘ä¸Šä¸‹æ–‡
                if (audioCtx.state === 'suspended') audioCtx.resume();

                e.preventDefault(); // é˜²æ­¢é¡µé¢æ»šåŠ¨
                const point = e.touches ? e.touches[0] : e;
                
                startX = point.clientX;
                startY = point.clientY;
                
                card.classList.add('dragging');
                playSound('click');
            };

            const moveDrag = (e) => {
                if(!card.classList.contains('dragging')) return;
                e.preventDefault();
                
                const point = e.touches ? e.touches[0] : e;
                const dx = point.clientX - startX;
                const dy = point.clientY - startY;
                
                // ç§»åŠ¨å¡ç‰‡
                card.style.transform = `translate(${dx}px, ${dy}px) scale(1.2)`;
            };

            const endDrag = (e) => {
                if(!card.classList.contains('dragging')) return;
                card.classList.remove('dragging');
                
                // è·å–æ¾æ‰‹ä½ç½®çš„åæ ‡
                const point = e.changedTouches ? e.changedTouches[0] : e;
                const dropX = point.clientX;
                const dropY = point.clientY;
                
                // æš‚æ—¶éšè—è‡ªå·±ï¼Œä»¥ä¾¿æ¢æµ‹ä¸‹æ–¹çš„å…ƒç´ 
                card.style.visibility = 'hidden';
                const elementBelow = document.elementFromPoint(dropX, dropY);
                card.style.visibility = 'visible';
                
                // æŸ¥æ‰¾ç›®æ ‡å¡ç‰‡
                const targetCard = elementBelow ? elementBelow.closest('.card') : null;

                // åˆ¤å®šé€»è¾‘
                if (targetCard && targetCard !== card && !targetCard.classList.contains('matched')) {
                    checkMatch(card, targetCard);
                } else {
                    // æ²¡æ‹–åˆ°æœ‰æ•ˆç›®æ ‡ï¼Œå›å¼¹
                    resetCardPosition(card);
                }
            };

            // ç»‘å®šäº‹ä»¶ (æ”¯æŒé¼ æ ‡å’Œè§¦æ‘¸)
            card.addEventListener('mousedown', startDrag);
            document.addEventListener('mousemove', moveDrag);
            document.addEventListener('mouseup', endDrag);

            card.addEventListener('touchstart', startDrag, {passive: false});
            document.addEventListener('touchmove', moveDrag, {passive: false});
            document.addEventListener('touchend', endDrag);
        }

        function checkMatch(card1, card2) {
            // æ£€æŸ¥ pairId æ˜¯å¦ä¸€è‡´
            if (card1.dataset.pairId === card2.dataset.pairId) {
                // âœ… åŒ¹é…æˆåŠŸ
                playSound('match');
                
                // ä¸¤ä¸ªéƒ½æ¶ˆé™¤
                card1.classList.add('matched');
                card2.classList.add('matched');
                
                // æ›´æ–°è¿›åº¦
                matchedCount++;
                updateProgress();
                
                if(matchedCount >= totalPairs) {
                    endGame(true);
                }
            } else {
                // âŒ åŒ¹é…å¤±è´¥
                playSound('wrong');
                
                // ç›®æ ‡å¡ç‰‡éœ‡åŠ¨æç¤º
                card2.classList.add('wrong');
                setTimeout(() => card2.classList.remove('wrong'), 400);
                
                // æ‹–æ‹½å¡ç‰‡å›å¼¹
                resetCardPosition(card1);
            }
        }

        function resetCardPosition(card) {
            // ä½¿ç”¨ transition å¹³æ»‘å›å¼¹
            card.style.transition = 'transform 0.3s ease-out';
            card.style.transform = 'translate(0, 0)';
            
            // åŠ¨ç”»ç»“æŸåæ¸…é™¤ transitionï¼Œä»¥å…å½±å“ä¸‹ä¸€æ¬¡æ‹–æ‹½
            setTimeout(() => {
                card.style.transition = '';
            }, 300);
        }

        function updateProgress() {
            const pct = (matchedCount / totalPairs) * 100;
            document.getElementById('progressBar').style.width = `${pct}%`;
        }

        // ================= 6. è®¡æ—¶ä¸ç»“ç®— =================
        function startTimer() {
            clearInterval(gameTimer);
            startTime = Date.now();
            const display = document.getElementById('gameTimer');
            
            if(isTimeMode) {
                let timeLeft = 60;
                display.textContent = timeLeft;
                gameTimer = setInterval(() => {
                    timeLeft--;
                    display.textContent = timeLeft;
                    if(timeLeft <= 0) endGame(false);
                }, 1000);
            } else {
                gameTimer = setInterval(() => {
                    const diff = Math.floor((Date.now() - startTime) / 1000);
                    const m = String(Math.floor(diff / 60)).padStart(2, '0');
                    const s = String(diff % 60).padStart(2, '0');
                    display.textContent = `${m}:${s}`;
                }, 1000);
            }
        }

        function endGame(success) {
            clearInterval(gameTimer);
            if(success) {
                playSound('win');
                const timeStr = document.getElementById('gameTimer').textContent;
                document.getElementById('resTitle').textContent = 'ğŸ‰ æŒ‘æˆ˜æˆåŠŸ';
                document.getElementById('resTime').textContent = timeStr;
                document.getElementById('resScore').textContent = '100';
                document.getElementById('resultModal').classList.add('open');
            } else {
                alert('æ—¶é—´åˆ°ï¼æŒ‘æˆ˜å¤±è´¥');
                exitGame();
            }
        }

        function exitGame() {
            clearInterval(gameTimer);
            document.getElementById('gameScreen').style.display = 'none';
        }

        function closeModal() {
            document.getElementById('resultModal').classList.remove('open');
            exitGame();
        }
        
        // é¦–æ¬¡ç‚¹å‡»æ¿€æ´»éŸ³é¢‘
        document.body.addEventListener('click', () => {
            if (audioCtx.state === 'suspended') audioCtx.resume();
        }, { once: true });

    </script>
</body>
</html>
