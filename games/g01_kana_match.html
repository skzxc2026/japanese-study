<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å‡åæ¶ˆæ¶ˆä¹ V7.2</title>
    <style>
        :root {
            --bg-color: #f8f9fa;
            --text-main: #2d3436;
            --font-cn: "Microsoft YaHei", "PingFang SC", sans-serif;
            --font-jp: "M PLUS Rounded 1c", sans-serif;
            
            /* å“ç‰Œè‰² */
            --c-green: #00b894;
            --c-blue: #0984e3;
            --c-purple: #6c5ce7;
            --c-red: #d63031;
        }

        body {
            font-family: var(--font-cn);
            background-color: var(--bg-color);
            margin: 0; height: 100vh;
            overflow: hidden; user-select: none;
            color: var(--text-main);
        }

        /* ================= å¸ƒå±€å®¹å™¨ ================= */
        .app-container {
            display: flex;
            width: 100%; height: 100%;
            position: relative;
            transition: all 0.5s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        /* å·¦ä¾§ï¼šä¸»èœå•é¢æ¿ */
        .left-panel {
            flex: 1;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            background: white;
            z-index: 10;
            box-shadow: 5px 0 30px rgba(0,0,0,0.05);
            transition: all 0.5s ease;
            padding: 20px;
        }
        
        .app-container.mode-active .left-panel {
            flex: 0 0 35%; 
            align-items: flex-end; 
            padding-right: 40px;
            background: #f1f2f6; 
        }

        /* å³ä¾§ï¼šå­èœå•é¢æ¿ */
        .right-panel {
            flex: 0; width: 0; opacity: 0;
            background: white;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            overflow: hidden;
            transition: all 0.5s ease;
            position: relative;
        }

        .app-container.mode-active .right-panel {
            flex: 1; width: auto; opacity: 1;
        }

        /* ================= å·¦ä¾§å†…å®¹è®¾è®¡ ================= */
        .title-area {
            text-align: center; margin-bottom: 40px;
            transition: transform 0.4s;
        }
        .app-title {
            font-size: 48px; font-weight: 900; color: #333;
            letter-spacing: 2px; margin: 0;
        }
        .app-subtitle { color: #b2bec3; font-size: 16px; margin-top: 5px; font-weight: bold; }

        .menu-list {
            display: flex; flex-direction: column; gap: 20px;
            width: 100%; max-width: 320px;
        }

        .mode-card {
            background: white; border-radius: 20px; padding: 20px 25px;
            display: flex; align-items: center; justify-content: space-between;
            cursor: pointer; transition: all 0.3s;
            border: 2px solid transparent;
            box-shadow: 0 10px 20px rgba(0,0,0,0.05);
            position: relative; overflow: hidden;
        }
        
        .icon-circle {
            width: 50px; height: 50px; border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            font-size: 24px; color: white; margin-right: 15px; flex-shrink: 0;
        }

        .mode-info { flex: 1; }
        .m-title { font-size: 20px; font-weight: bold; color: #2d3436; }
        .m-desc { font-size: 12px; color: #aaa; margin-top: 2px; }
        .arrow { color: #ddd; font-weight: bold; transition: 0.3s; }

        .mc-green .icon-circle { background: linear-gradient(135deg, #55efc4, #00b894); }
        .mc-blue .icon-circle  { background: linear-gradient(135deg, #74b9ff, #0984e3); }
        .mc-purple .icon-circle{ background: linear-gradient(135deg, #a29bfe, #6c5ce7); }
        .mc-red .icon-circle   { background: linear-gradient(135deg, #ff7675, #d63031); }

        .mode-card:hover { transform: translateY(-3px); box-shadow: 0 15px 30px rgba(0,0,0,0.1); }
        .mode-card:hover .arrow { color: #333; transform: translateX(5px); }

        .app-container.mode-active .mode-card {
            padding: 15px; background: white; opacity: 0.6; transform: scale(0.95);
        }
        .app-container.mode-active .mode-card.active {
            opacity: 1; border-color: var(--active-color);
            transform: scale(1.05) translateX(10px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1); z-index: 2;
        }

        /* ================= å³ä¾§å†…å®¹è®¾è®¡ ================= */
        .sub-content {
            width: 90%; max-width: 450px; padding: 20px;
            animation: slideIn 0.4s 0.1s backwards;
        }
        
        .sub-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .sub-title { font-size: 28px; font-weight: 800; color: #333; }
        
        .chapter-grid { display: grid; gap: 15px; }
        
        .chapter-item {
            background: white; border: 1px solid #eee;
            border-radius: 16px; padding: 20px;
            display: flex; align-items: center; justify-content: space-between;
            cursor: pointer; transition: 0.2s;
        }
        .chapter-item:hover {
            border-color: var(--active-color); background: #fdfdfd;
            transform: translateX(5px); box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }
        
        .cp-left h3 { margin: 0; font-size: 18px; color: #333; }
        .cp-left p { margin: 5px 0 0; font-size: 13px; color: #999; }
        .cp-tag {
            font-size: 12px; font-weight: bold; padding: 5px 12px;
            border-radius: 20px; background: #f0f0f0; color: #666;
        }

        .timer-switch {
            display: flex; align-items: center; gap: 10px;
            background: #fff; padding: 8px 16px; border-radius: 30px;
            border: 1px solid #eee; font-size: 14px; font-weight: bold; color: #555;
        }
        .switch-ui {
            width: 40px; height: 22px; background: #ccc; border-radius: 22px;
            position: relative; transition: 0.3s; cursor: pointer;
        }
        .switch-ui::after {
            content:''; position: absolute; top: 2px; left: 2px; width: 18px; height: 18px;
            background: white; border-radius: 50%; transition: 0.3s;
        }
        input:checked + .switch-ui { background: #ff6b6b; }
        input:checked + .switch-ui::after { transform: translateX(18px); }

        .close-sub-btn { display: none; font-size: 24px; color: #999; cursor: pointer; }

        /* ================= 3. æ¸¸æˆç•Œé¢ ================= */
        .game-screen {
            display: none; flex-direction: column; height: 100%;
            position: fixed; top: 0; left: 0; width: 100%; z-index: 200;
            background: #fdfbf7;
        }
        
        .header {
            padding: 15px 20px; background: white;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); z-index: 10;
        }
        .top-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        
        /* é¡¶éƒ¨æŒ‰é’®ç»„ */
        .btn-group { display: flex; gap: 10px; align-items: center; }
        .icon-btn {
            border: none; background: #eee; width: 40px; height: 40px; border-radius: 50%;
            font-size: 20px; cursor: pointer; display: flex; justify-content: center; align-items: center;
            transition: 0.2s;
        }
        .icon-btn:active { transform: scale(0.9); background: #ddd; }

        .lvl-info { font-size: 20px; font-weight: 900; color: #2c3e50; }
        .timer-display { font-size: 24px; font-weight: bold; color: #e74c3c; font-family: monospace; }
        
        .progress-track { width: 100%; height: 8px; background: #f0f0f0; border-radius: 4px; overflow: hidden; }
        .progress-fill { height: 100%; background: #2ecc71; width: 0%; transition: width 0.3s; }

        .board {
            flex: 1; padding: 20px;
            display: flex; flex-wrap: wrap; justify-content: center; align-content: center;
            gap: 15px; overflow-y: auto;
        }

        .card {
            width: 75px; height: 75px; border-radius: 18px;
            display: flex; justify-content: center; align-items: center;
            font-size: 26px; font-weight: bold; cursor: pointer; position: relative;
            transition: transform 0.1s; background: white; color: #555;
            box-shadow: 0 6px 0 rgba(0,0,0,0.1); opacity: 0; transform: translateY(20px);
        }
        .card.show { opacity: 1; transform: translateY(0); }
        .card:active { transform: translateY(6px); box-shadow: 0 0 0 rgba(0,0,0,0); }
        .card.matched { transform: scale(0); opacity: 0; transition: 0.4s; pointer-events: none; }
        .card.selected { transform: translateY(6px); box-shadow: inset 0 3px 5px rgba(0,0,0,0.1); filter: brightness(0.95); }
        .card.wrong { animation: shake 0.4s; background: #ff7675 !important; color: white !important; }
        .card.color-a { background: var(--c1-bg); color: var(--c1-txt); box-shadow: 0 6px 0 var(--c1-shadow); }
        .card.color-b { background: var(--c2-bg); color: var(--c2-txt); box-shadow: 0 6px 0 var(--c2-shadow); }
        .card.romaji { font-family: "Varela Round", sans-serif; font-size: 20px; }
        .card.kana { font-family: var(--font-jp); }

        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 300;
            display: none; justify-content: center; align-items: center; flex-direction: column;
        }
        .modal-box { background: white; padding: 30px; border-radius: 20px; text-align: center; width: 80%; max-width: 300px; }
        .modal h2 { margin: 0 0 10px; font-size: 32px; }
        .modal-btn { background: #3498db; color: white; padding: 12px 30px; border-radius: 30px; border: none; font-size: 18px; cursor: pointer; margin-top: 20px; }

        #confetti { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 250; }

        @keyframes slideIn { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-6px); } 75% { transform: translateX(6px); } }

        @media (max-width: 768px) {
            .app-container.mode-active .left-panel { flex: 0 0 0; padding: 0; overflow: hidden; }
            .close-sub-btn { display: block; }
            .title-area { margin-bottom: 20px; }
            .app-title { font-size: 36px; }
            .mode-card { padding: 15px; }
        }

    </style>
</head>
<body>

    <canvas id="confetti"></canvas>

    <!-- ä¸»å®¹å™¨ -->
    <div class="app-container" id="appContainer">
        <!-- å·¦ä¾§ -->
        <div class="left-panel">
            <div class="title-area">
                <h1 class="app-title">å‡åæ¶ˆæ¶ˆä¹</h1>
                <div class="app-subtitle">Kana Match V7.2</div>
            </div>
            <div class="menu-list">
                <div class="mode-card mc-green" onclick="selectMode('seion', this, '#00b894')">
                    <div class="icon-circle">ğŸŒ±</div>
                    <div class="mode-info"><div class="m-title">æ¸…éŸ³ç¯‡</div><div class="m-desc">åŸºç¡€äº”åéŸ³ (a-n)</div></div>
                    <div class="arrow">&gt;</div>
                </div>
                <div class="mode-card mc-blue" onclick="selectMode('dakuon', this, '#0984e3')">
                    <div class="icon-circle">ğŸŒŠ</div>
                    <div class="mode-info"><div class="m-title">æµŠéŸ³ç¯‡</div><div class="m-desc">ç‚¹ç‚¹åœˆåœˆ (ga, pa)</div></div>
                    <div class="arrow">&gt;</div>
                </div>
                <div class="mode-card mc-purple" onclick="selectMode('yoon', this, '#6c5ce7')">
                    <div class="icon-circle">ğŸŒªï¸</div>
                    <div class="mode-info"><div class="m-title">æ‹—éŸ³ç¯‡</div><div class="m-desc">ç»„åˆéŸ³ (kya, shu)</div></div>
                    <div class="arrow">&gt;</div>
                </div>
                <div class="mode-card mc-red" onclick="selectMode('mix', this, '#d63031')">
                    <div class="icon-circle">ğŸ‘‘</div>
                    <div class="mode-info"><div class="m-title">å¤§ç»¼åˆ</div><div class="m-desc">å…¨èƒ½å¤§å¸ˆæŒ‘æˆ˜</div></div>
                    <div class="arrow">&gt;</div>
                </div>
            </div>
        </div>

        <!-- å³ä¾§ -->
        <div class="right-panel">
            <div class="sub-content">
                <div class="sub-header">
                    <div>
                        <div class="sub-title" id="subTitle">é€‰æ‹©ç« èŠ‚</div>
                        <div style="font-size:12px; color:#999; margin-top:5px;">è¯·é€‰æ‹©å¼€å§‹çš„å…³å¡</div>
                    </div>
                    <div style="display:flex; align-items:center; gap:15px;">
                        <label class="timer-switch">
                            <input type="checkbox" id="timerToggle" checked hidden>
                            <div class="switch-ui"></div><span>é™æ—¶</span>
                        </label>
                        <div class="close-sub-btn" onclick="closeSubMenu()">âœ•</div>
                    </div>
                </div>
                <div class="chapter-grid">
                    <div class="chapter-item" onclick="startLevel(1)">
                        <div class="cp-left"><h3>åŸºç¡€å…¥é—¨</h3><p>Level 1 - 10</p></div>
                        <div class="cp-tag">ç½—é©¬éŸ³ â†” å¹³å‡å</div>
                    </div>
                    <div class="chapter-item" onclick="startLevel(11)">
                        <div class="cp-left"><h3>è¿›é˜¶æŒ‘æˆ˜</h3><p>Level 11 - 20</p></div>
                        <div class="cp-tag">ç½—é©¬éŸ³ â†” ç‰‡å‡å</div>
                    </div>
                    <div class="chapter-item" onclick="startLevel(21)">
                        <div class="cp-left"><h3>å‡åè½¬æ¢</h3><p>Level 21 - 30</p></div>
                        <div class="cp-tag">å¹³å‡å â†” ç‰‡å‡å</div>
                    </div>
                    <div class="chapter-item" onclick="startLevel(31)">
                        <div class="cp-left"><h3 style="color:#d63031">åœ°ç‹±æ··åˆ</h3><p>Level 31 - 50</p></div>
                        <div class="cp-tag" style="background:#ffecec; color:#d63031">ğŸ”¥ éšæœºå¤§ä¹±æ–—</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- æ¸¸æˆç•Œé¢ -->
    <div class="game-screen" id="gameScreen">
        <div class="header">
            <div class="top-row">
                <!-- å·¦ä¸Šè§’æŒ‰é’®ç»„ -->
                <div class="btn-group">
                    <button class="icon-btn" onclick="quitGame()">ğŸ¡</button>
                    <button class="icon-btn" id="voiceToggleBtn" onclick="toggleVoice()">ğŸ”Š</button>
                </div>

                <div class="lvl-info" id="lvlDisplay">Level 1</div>
                <div class="timer-display" id="timerDisplay">60</div>
            </div>
            <div class="progress-track"><div class="progress-fill" id="progressBar"></div></div>
        </div>
        <div class="board" id="board"></div>
    </div>

    <!-- ç»“ç®—å¼¹çª— -->
    <div class="modal" id="resultModal">
        <div class="modal-box">
            <h2 id="modalTitle">ğŸ‰ æˆåŠŸ!</h2>
            <p id="modalMsg" style="color:#666">è¿›å…¥ä¸‹ä¸€å…³...</p>
            <button class="modal-btn" id="modalBtn" onclick="nextLevel()">ç»§ç»­</button>
        </div>
    </div>

    <script>
        // ================= äº¤äº’é€»è¾‘ =================
        let currentMode = 'seion';
        let isVoiceOn = true; // é»˜è®¤å¼€å¯è¯­éŸ³
        
        function selectMode(mode, el, color) {
            currentMode = mode;
            document.getElementById('appContainer').classList.add('mode-active');
            document.querySelectorAll('.mode-card').forEach(c => c.classList.remove('active'));
            el.classList.add('active');
            document.documentElement.style.setProperty('--active-color', color);
            if(audioCtx.state === 'suspended') audioCtx.resume();
        }

        function closeSubMenu() {
            document.getElementById('appContainer').classList.remove('mode-active');
            document.querySelectorAll('.mode-card').forEach(c => c.classList.remove('active'));
        }

        function startLevel(lvl) {
            currentLevel = lvl;
            isTimerOn = document.getElementById('timerToggle').checked;
            document.getElementById('gameScreen').style.display = 'flex';
            loadRound();
        }

        function quitGame() {
            clearInterval(timerInterval);
            document.getElementById('gameScreen').style.display = 'none';
        }

        // åˆ‡æ¢æ—¥è¯­å‘éŸ³å¼€å…³
        function toggleVoice() {
            isVoiceOn = !isVoiceOn;
            const btn = document.getElementById('voiceToggleBtn');
            btn.innerText = isVoiceOn ? 'ğŸ”Š' : 'ğŸ”‡';
        }

        // ================= æ¸¸æˆæ•°æ® =================
        const DATA = {
            seion: [
                {r:'a', h:'ã‚', k:'ã‚¢'}, {r:'i', h:'ã„', k:'ã‚¤'}, {r:'u', h:'ã†', k:'ã‚¦'}, {r:'e', h:'ãˆ', k:'ã‚¨'}, {r:'o', h:'ãŠ', k:'ã‚ª'},
                {r:'ka', h:'ã‹', k:'ã‚«'}, {r:'ki', h:'ã', k:'ã‚­'}, {r:'ku', h:'ã', k:'ã‚¯'}, {r:'ke', h:'ã‘', k:'ã‚±'}, {r:'ko', h:'ã“', k:'ã‚³'},
                {r:'sa', h:'ã•', k:'ã‚µ'}, {r:'shi', h:'ã—', k:'ã‚·'}, {r:'su', h:'ã™', k:'ã‚¹'}, {r:'se', h:'ã›', k:'ã‚»'}, {r:'so', h:'ã', k:'ã‚½'},
                {r:'ta', h:'ãŸ', k:'ã‚¿'}, {r:'chi', h:'ã¡', k:'ãƒ'}, {r:'tsu', h:'ã¤', k:'ãƒ„'}, {r:'te', h:'ã¦', k:'ãƒ†'}, {r:'to', h:'ã¨', k:'ãƒˆ'},
                {r:'na', h:'ãª', k:'ãƒŠ'}, {r:'ni', h:'ã«', k:'ãƒ‹'}, {r:'nu', h:'ã¬', k:'ãƒŒ'}, {r:'ne', h:'ã­', k:'ãƒ'}, {r:'no', h:'ã®', k:'ãƒ'},
                {r:'ha', h:'ã¯', k:'ãƒ'}, {r:'hi', h:'ã²', k:'ãƒ’'}, {r:'fu', h:'ãµ', k:'ãƒ•'}, {r:'he', h:'ã¸', k:'ãƒ˜'}, {r:'ho', h:'ã»', k:'ãƒ›'},
                {r:'ma', h:'ã¾', k:'ãƒ'}, {r:'mi', h:'ã¿', k:'ãƒŸ'}, {r:'mu', h:'ã‚€', k:'ãƒ '}, {r:'me', h:'ã‚', k:'ãƒ¡'}, {r:'mo', h:'ã‚‚', k:'ãƒ¢'},
                {r:'ya', h:'ã‚„', k:'ãƒ¤'}, {r:'yu', h:'ã‚†', k:'ãƒ¦'}, {r:'yo', h:'ã‚ˆ', k:'ãƒ¨'},
                {r:'ra', h:'ã‚‰', k:'ãƒ©'}, {r:'ri', h:'ã‚Š', k:'ãƒª'}, {r:'ru', h:'ã‚‹', k:'ãƒ«'}, {r:'re', h:'ã‚Œ', k:'ãƒ¬'}, {r:'ro', h:'ã‚', k:'ãƒ­'},
                {r:'wa', h:'ã‚', k:'ãƒ¯'}, {r:'wo', h:'ã‚’', k:'ãƒ²'}, {r:'n', h:'ã‚“', k:'ãƒ³'}
            ],
            dakuon: [
                {r:'ga', h:'ãŒ', k:'ã‚¬'}, {r:'gi', h:'ã', k:'ã‚®'}, {r:'gu', h:'ã', k:'ã‚°'}, {r:'ge', h:'ã’', k:'ã‚²'}, {r:'go', h:'ã”', k:'ã‚´'},
                {r:'za', h:'ã–', k:'ã‚¶'}, {r:'ji', h:'ã˜', k:'ã‚¸'}, {r:'zu', h:'ãš', k:'ã‚º'}, {r:'ze', h:'ãœ', k:'ã‚¼'}, {r:'zo', h:'ã', k:'ã‚¾'},
                {r:'da', h:'ã ', k:'ãƒ€'}, {r:'ji', h:'ã¢', k:'ãƒ‚'}, {r:'zu', h:'ã¥', k:'ãƒ…'}, {r:'de', h:'ã§', k:'ãƒ‡'}, {r:'do', h:'ã©', k:'ãƒ‰'},
                {r:'ba', h:'ã°', k:'ãƒ'}, {r:'bi', h:'ã³', k:'ãƒ“'}, {r:'bu', h:'ã¶', k:'ãƒ–'}, {r:'be', h:'ã¹', k:'ãƒ™'}, {r:'bo', h:'ã¼', k:'ãƒœ'},
                {r:'pa', h:'ã±', k:'ãƒ‘'}, {r:'pi', h:'ã´', k:'ãƒ”'}, {r:'pu', h:'ã·', k:'ãƒ—'}, {r:'pe', h:'ãº', k:'ãƒš'}, {r:'po', h:'ã½', k:'ãƒ'}
            ],
            yoon: [
                {r:'kya', h:'ãã‚ƒ', k:'ã‚­ãƒ£'}, {r:'kyu', h:'ãã‚…', k:'ã‚­ãƒ¥'}, {r:'kyo', h:'ãã‚‡', k:'ã‚­ãƒ§'},
                {r:'sha', h:'ã—ã‚ƒ', k:'ã‚·ãƒ£'}, {r:'shu', h:'ã—ã‚…', k:'ã‚·ãƒ¥'}, {r:'sho', h:'ã—ã‚‡', k:'ã‚·ãƒ§'},
                {r:'cha', h:'ã¡ã‚ƒ', k:'ãƒãƒ£'}, {r:'chu', h:'ã¡ã‚…', k:'ãƒãƒ¥'}, {r:'cho', h:'ã¡ã‚‡', k:'ãƒãƒ§'},
                {r:'nya', h:'ã«ã‚ƒ', k:'ãƒ‹ãƒ£'}, {r:'nyu', h:'ã«ã‚…', k:'ãƒ‹ãƒ¥'}, {r:'nyo', h:'ã«ã‚‡', k:'ãƒ‹ãƒ§'},
                {r:'hya', h:'ã²ã‚ƒ', k:'ãƒ’ãƒ£'}, {r:'hyu', h:'ã²ã‚…', k:'ãƒ’ãƒ¥'}, {r:'hyo', h:'ã²ã‚‡', k:'ãƒ’ãƒ§'},
                {r:'mya', h:'ã¿ã‚ƒ', k:'ãƒŸãƒ£'}, {r:'myu', h:'ã¿ã‚…', k:'ãƒŸãƒ¥'}, {r:'myo', h:'ã¿ã‚‡', k:'ãƒŸãƒ§'},
                {r:'rya', h:'ã‚Šã‚ƒ', k:'ãƒªãƒ£'}, {r:'ryu', h:'ã‚Šã‚…', k:'ãƒªãƒ¥'}, {r:'ryo', h:'ã‚Šã‚‡', k:'ãƒªãƒ§'},
                {r:'gya', h:'ãã‚ƒ', k:'ã‚®ãƒ£'}, {r:'gyu', h:'ãã‚…', k:'ã‚®ãƒ¥'}, {r:'gyo', h:'ãã‚‡', k:'ã‚®ãƒ§'},
                {r:'ja', h:'ã˜ã‚ƒ', k:'ã‚¸ãƒ£'},  {r:'ju', h:'ã˜ã‚…', k:'ã‚¸ãƒ¥'},  {r:'jo', h:'ã˜ã‚‡', k:'ã‚¸ãƒ§'},
                {r:'bya', h:'ã³ã‚ƒ', k:'ãƒ“ãƒ£'}, {r:'byu', h:'ã³ã‚…', k:'ãƒ“ãƒ¥'}, {r:'byo', h:'ã³ã‚‡', k:'ãƒ“ãƒ§'},
                {r:'pya', h:'ã´ã‚ƒ', k:'ãƒ”ãƒ£'}, {r:'pyu', h:'ã´ã‚…', k:'ãƒ”ãƒ¥'}, {r:'pyo', h:'ã´ã‚‡', k:'ãƒ”ãƒ§'}
            ]
        };

        const THEMES = [
            { c1: {bg:'#ff9ff3', txt:'#fff', sh:'#f368e0'}, c2: {bg:'#54a0ff', txt:'#fff', sh:'#2e86de'} },
            { c1: {bg:'#feca57', txt:'#fff', sh:'#ff9f43'}, c2: {bg:'#1dd1a1', txt:'#fff', sh:'#10ac84'} },
            { c1: {bg:'#ff6b6b', txt:'#fff', sh:'#ee5253'}, c2: {bg:'#48dbfb', txt:'#fff', sh:'#0abde3'} },
            { c1: {bg:'#a29bfe', txt:'#fff', sh:'#6c5ce7'}, c2: {bg:'#55efc4', txt:'#555', sh:'#00b894'} },
            { c1: {bg:'#fab1a0', txt:'#fff', sh:'#e17055'}, c2: {bg:'#74b9ff', txt:'#fff', sh:'#0984e3'} }
        ];

        let currentLevel = 1;
        let maxLevel = 50;
        let isTimerOn = true;
        let timerInterval;
        let timeLeft = 60;
        let selectedCards = [];
        let matchedCount = 0;
        let isLocked = false;

        function loadRound() {
            document.getElementById('lvlDisplay').innerText = `Level ${currentLevel}`;
            document.getElementById('progressBar').style.width = '0%';
            document.getElementById('resultModal').style.display = 'none';
            
            if (isTimerOn) {
                if(currentLevel <= 10) timeLeft = 60;
                else if(currentLevel <= 20) timeLeft = 50;
                else if(currentLevel <= 30) timeLeft = 40;
                else timeLeft = 30;
                document.getElementById('timerDisplay').innerText = timeLeft;
                document.getElementById('timerDisplay').style.display = 'block';
                startTimer();
            } else {
                document.getElementById('timerDisplay').style.display = 'none';
            }

            const board = document.getElementById('board');
            board.innerHTML = '';
            matchedCount = 0;
            selectedCards = [];
            isLocked = false;

            let pool = [];
            if (currentMode === 'mix') pool = [...DATA.seion, ...DATA.dakuon, ...DATA.yoon];
            else pool = DATA[currentMode];

            let roundData = [...pool].sort(() => 0.5 - Math.random()).slice(0, 10);
            const theme = THEMES[Math.floor(Math.random() * THEMES.length)];
            document.documentElement.style.setProperty('--c1-bg', theme.c1.bg);
            document.documentElement.style.setProperty('--c1-txt', theme.c1.txt);
            document.documentElement.style.setProperty('--c1-shadow', theme.c1.sh);
            document.documentElement.style.setProperty('--c2-bg', theme.c2.bg);
            document.documentElement.style.setProperty('--c2-txt', theme.c2.txt);
            document.documentElement.style.setProperty('--c2-shadow', theme.c2.sh);

            let cards = [];
            roundData.forEach((item, idx) => {
                let type = 0; 
                if(currentLevel <= 10) type = 0;
                else if(currentLevel <= 20) type = 1;
                else if(currentLevel <= 30) type = 2;
                else type = Math.floor(Math.random() * 3);

                let t1, t2;
                if (type === 0) {
                    t1 = { txt: item.r, cls: 'romaji color-a' };
                    t2 = { txt: item.h, cls: 'kana color-b' };
                } else if (type === 1) {
                    t1 = { txt: item.r, cls: 'romaji color-a' };
                    t2 = { txt: item.k, cls: 'kana color-b' };
                } else {
                    t1 = { txt: item.h, cls: 'kana color-a' };
                    t2 = { txt: item.k, cls: 'kana color-b' };
                }
                cards.push({ ...t1, mid: idx, sound: item.h });
                cards.push({ ...t2, mid: idx, sound: item.h });
            });

            cards.sort(() => 0.5 - Math.random());
            cards.forEach((c, i) => {
                const el = document.createElement('div');
                el.className = `card ${c.cls}`;
                el.innerText = c.txt;
                el.dataset.mid = c.mid;
                el.dataset.sound = c.sound;
                el.onclick = () => cardClick(el);
                board.appendChild(el);
                setTimeout(() => el.classList.add('show'), i * 30);
            });
        }

        function cardClick(el) {
            if (isLocked || el.classList.contains('matched') || el.classList.contains('selected')) return;
            
            // åªæœ‰å½“è¯­éŸ³å¼€å…³æ‰“å¼€æ—¶æ‰æœ—è¯»
            if (isVoiceOn) {
                speak(el.dataset.sound);
            }
            
            el.classList.add('selected');
            selectedCards.push(el);
            
            if (selectedCards.length === 2) {
                isLocked = true;
                const [c1, c2] = selectedCards;
                if (c1.dataset.mid === c2.dataset.mid) {
                    // æ— è®ºè¯­éŸ³å¼€å…³å¦‚ä½•ï¼Œå§‹ç»ˆæ’­æ”¾éŸ³æ•ˆ
                    playSound('ding');
                    setTimeout(() => {
                        c1.classList.add('matched'); c2.classList.add('matched');
                        matchedCount++;
                        document.getElementById('progressBar').style.width = (matchedCount / 10 * 100) + '%';
                        resetSel();
                        if (matchedCount === 10) winLevel();
                    }, 300);
                } else {
                    playSound('buzz');
                    c1.classList.add('wrong'); c2.classList.add('wrong');
                    setTimeout(() => {
                        c1.classList.remove('wrong', 'selected'); c2.classList.remove('wrong', 'selected');
                        resetSel();
                    }, 500);
                }
            }
        }

        function resetSel() { selectedCards = []; isLocked = false; }
        function startTimer() {
            clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                timeLeft--;
                document.getElementById('timerDisplay').innerText = timeLeft;
                if (timeLeft <= 0) { clearInterval(timerInterval); showModal(false); }
            }, 1000);
        }
        function winLevel() { clearInterval(timerInterval); fireConfetti(); showModal(true); }
        function showModal(win) {
            const m = document.getElementById('resultModal');
            const t = document.getElementById('modalTitle');
            const msg = document.getElementById('modalMsg');
            const btn = document.getElementById('modalBtn');
            m.style.display = 'flex';
            if (win) {
                t.innerText = "ğŸ‰ é—¯å…³æˆåŠŸ!"; t.style.color = "#2ecc71";
                msg.innerText = currentLevel === maxLevel ? "æ­å–œé€šå…³ï¼" : "å‡†å¤‡å¥½è¿›å…¥ä¸‹ä¸€å…³äº†å—ï¼Ÿ";
                btn.innerText = currentLevel === maxLevel ? "è¿”å›ä¸»é¡µ" : "ä¸‹ä¸€å…³";
                btn.onclick = currentLevel === maxLevel ? quitGame : nextLevel;
            } else {
                t.innerText = "â° æ—¶é—´åˆ°!"; t.style.color = "#e74c3c";
                msg.innerText = "ä¸è¦ç°å¿ƒï¼Œå†è¯•ä¸€æ¬¡ï¼";
                btn.innerText = "é‡è¯•";
                btn.onclick = () => { m.style.display = 'none'; loadRound(); };
            }
        }
        function nextLevel() { currentLevel++; loadRound(); }

        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSound(type) {
            if(audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain();
            osc.connect(gain); gain.connect(audioCtx.destination);
            if(type === 'ding') {
                osc.type = 'triangle'; osc.frequency.setValueAtTime(600, audioCtx.currentTime); 
                osc.frequency.exponentialRampToValueAtTime(1200, audioCtx.currentTime + 0.1);
                gain.gain.setValueAtTime(0.2, audioCtx.currentTime); gain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.3);
            } else {
                osc.type = 'sawtooth'; osc.frequency.setValueAtTime(150, audioCtx.currentTime);
                gain.gain.setValueAtTime(0.2, audioCtx.currentTime); gain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.3);
            }
            osc.start(); osc.stop(audioCtx.currentTime + 0.3);
        }
        
        function speak(text) {
            if(/^[a-zA-Z]+$/.test(text)) return; 
            const u = new SpeechSynthesisUtterance(text); 
            u.lang = 'ja-JP'; 
            speechSynthesis.speak(u);
        }
        
        const canvas = document.getElementById('confetti'); const ctx = canvas.getContext('2d');
        let particles = [];
        window.onresize = () => { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }; window.onresize();
        function fireConfetti() {
            for(let i=0; i<80; i++) particles.push({x: canvas.width/2, y: canvas.height/2, vx: (Math.random()-0.5)*15, vy: (Math.random()-0.5)*15, c: `hsl(${Math.random()*360}, 100%, 50%)`, life: 100});
            loopConfetti();
        }
        function loopConfetti() {
            ctx.clearRect(0,0,canvas.width,canvas.height);
            particles.forEach((p,i) => { p.x+=p.vx; p.y+=p.vy; p.vy+=0.5; p.life--; ctx.fillStyle=p.c; ctx.fillRect(p.x,p.y,6,6); if(p.life<=0) particles.splice(i,1); });
            if(particles.length>0) requestAnimationFrame(loopConfetti);
        }
    </script>
    <!-- ================= ğŸ® é€šç”¨æ¸¸æˆæ§åˆ¶æ  (å¤åˆ¶åˆ°æ‰€æœ‰æ¸¸æˆæ–‡ä»¶) ================= -->
<div id="game-controls" style="
    position: fixed; 
    top: 10px; 
    right: 10px; 
    z-index: 9999; 
    display: flex; 
    gap: 8px;
">
    <button onclick="doPause()" style="
        background: rgba(255, 255, 255, 0.9); 
        border: 1px solid #ddd; 
        padding: 8px 15px; 
        border-radius: 20px; 
        cursor: pointer; 
        font-weight: bold;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    ">â¸ï¸ æš‚åœ</button>

    <button onclick="goBack()" style="
        background: rgba(255, 255, 255, 0.9); 
        border: 1px solid #ddd; 
        padding: 8px 15px; 
        border-radius: 20px; 
        cursor: pointer; 
        font-weight: bold;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    ">ğŸ”™ è¿”å›</button>

    <button onclick="goHome()" style="
        background: #d93025; 
        color: white;
        border: none; 
        padding: 8px 15px; 
        border-radius: 20px; 
        cursor: pointer; 
        font-weight: bold;
        box-shadow: 0 2px 5px rgba(217, 48, 37, 0.3);
    ">ğŸ  ä¸»é¡µ</button>
</div>

<!-- æš‚åœé®ç½©å±‚ -->
<div id="pause-overlay" style="
    display: none;
    position: fixed; top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.85);
    z-index: 10000;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    color: white;
">
    <h1 style="font-size: 40px; margin-bottom: 20px;">â¸ï¸ æ¸¸æˆæš‚åœ</h1>
    <button onclick="resumeGame()" style="
        padding: 15px 40px;
        font-size: 20px;
        background: #00b894;
        color: white;
        border: none;
        border-radius: 50px;
        cursor: pointer;
        font-weight: bold;
    ">â–¶ï¸ ç»§ç»­æ¸¸æˆ</button>
</div>

<script>
    // 1. è¿”å›ä¸Šä¸€é¡µ (è°ƒç”¨çˆ¶çº§ index.html çš„æ–¹æ³•)
    function goBack() {
        if (window.parent && window.parent.closeGameMode) {
            window.parent.closeGameMode();
        } else {
            // å¦‚æœæ˜¯å•ç‹¬æ‰“å¼€çš„ç½‘é¡µï¼Œåˆ™é€€å›æµè§ˆå™¨å†å²
            history.back();
        }
    }

    // 2. è¿”å›ä¸»é¡µ (åˆ·æ–°çˆ¶çº§é¡µé¢)
    function goHome() {
        if (window.top) {
            window.top.location.reload();
        } else {
            location.reload();
        }
    }

    // 3. æš‚åœåŠŸèƒ½ (é€šç”¨é®ç½©æ³•)
    function doPause() {
        // æ˜¾ç¤ºé®ç½©
        document.getElementById('pause-overlay').style.display = 'flex';
        
        // å°è¯•æš‚åœè´ªåƒè›‡ (å¦‚æœå­˜åœ¨ gameLoop å˜é‡)
        if (typeof gameLoop !== 'undefined') clearInterval(gameLoop);
        if (typeof isPaused !== 'undefined') isPaused = true;
        
        // å°è¯•æš‚åœæ¶ˆæ¶ˆä¹/æ‹¼å›¾ (å¦‚æœæœ‰ timer å˜é‡)
        if (typeof timer !== 'undefined') clearInterval(timer);
    }

    // 4. ç»§ç»­åŠŸèƒ½
    function resumeGame() {
        document.getElementById('pause-overlay').style.display = 'none';
        
        // è¿™é‡Œçš„æ¢å¤é€»è¾‘å¯èƒ½éœ€è¦æ ¹æ®å…·ä½“æ¸¸æˆå¾®è°ƒ
        // å¤§å¤šæ•°ç®€å•çš„ JS æ¸¸æˆç‚¹å‡»ç»§ç»­åï¼Œæ‰‹åŠ¨æ“ä½œä¸€ä¸‹å°±ä¼šæ¢å¤ï¼Œæˆ–è€…é‡æ–°å¼€å§‹è®¡æ—¶
        if (typeof isPaused !== 'undefined') isPaused = false;
        
        // æç¤ºç”¨æˆ·
        // console.log("æ¸¸æˆå·²æ¢å¤ï¼Œè¯·å°è¯•æ“ä½œæˆ–ç‚¹å‡»å¼€å§‹");
    }
</script>
<!-- ====================================================================== -->

</body>
</html>
